import{a as ce}from"./chunk-GXF7AAOQ.js";import{a as de}from"./chunk-PU6S26UW.js";import{a as pe}from"./chunk-54KZ5YIV.js";import{a as le}from"./chunk-OTFCGVEU.js";import{a as se}from"./chunk-HPLI5COI.js";import{a as me}from"./chunk-GLWQGYBC.js";import{a as Y}from"./chunk-DC4QM32I.js";import{C as re,F as ae,c as W,f as te,n as oe,v as ne}from"./chunk-VHE3PQ3O.js";import{C as q,H as z,M as H,Qa as Z,V as $,W as J,X,Y as K,Z as Q,hb as ee,jb as ie,l as P,w as B}from"./chunk-GYDYF5F3.js";import{K as j,M as G,f as w,g as U,t as N}from"./chunk-PD5VTTIY.js";import{Aa as I,Ba as S,Hb as O,Ob as _,Yc as E,_b as d,cc as M,kc as c,lc as f,mc as C,nc as k,oc as R,qc as D,qd as L,rb as p,sb as l,wc as x,yc as u}from"./chunk-2NSPOFEK.js";import"./chunk-EU2KAMEK.js";import{a as T,b as A,d as V}from"./chunk-66YHNWRR.js";var v=class{static minDate(t){return e=>{if(!e.value)return null;let i=new Date(e.value);return i<t?{minDate:{requiredDate:t,actual:i}}:null}}static maxDate(t){return e=>{if(!e.value)return null;let i=new Date(e.value);return i>t?{maxDate:{requiredDate:t,actual:i}}:null}}static startToEndDateValidator(t,e){return i=>{let o=i.get(t),n=i.get(e);if(!o||!n)return null;let s=new Date(o.value),a=new Date(n.value);if(!s||!a)return null;if(a<s)return n.setErrors(A(T({},n.errors||{}),{dateOrderInvalid:!0})),{dateOrderInvalid:!0};if(n.errors?.dateOrderInvalid){let m=n.errors,{["dateOrderInvalid"]:g}=m,y=V(m,["dateOrderInvalid"]);n.setErrors(Object.keys(y).length?y:null)}return null}}};var he=()=>["Expense"],_e=()=>[];function ye(r,t){r&1&&(c(0,"div",8),C(1,"app-skeleton"),f())}function Fe(r,t){r&1&&(c(0,"div",4)(1,"div",5)(2,"div",6),_(3,ye,2,0,"div",7),f()()()),r&2&&(p(3),d("ngForOf",E(1,_e).constructor(10)))}function ve(r,t){if(r&1){let e=D();c(0,"div")(1,"app-form-field",17,0),x("valueChange",function(o){I(e);let n=u().$implicit,s=u(4);return S(s.onFieldChange(o,n))}),f()()}if(r&2){let e=u().$implicit,i=u(4);M("mb-4 ",e.class_name,""),p(),d("field",e)("form",i.myForm)}}function ge(r,t){if(r&1&&(k(0),_(1,ve,3,5,"div",16),R()),r&2){let e=t.$implicit;p(),d("ngIf",e.is_show===!0&&(e.is_parent_dependency===!1||e.is_child_show===!0))}}function be(r,t){if(r&1&&(c(0,"div",6),_(1,ge,2,1,"ng-container",15),f()),r&2){let e=u(3);p(),d("ngForOf",e.formFields)}}function xe(r,t){if(r&1){let e=D();c(0,"form",11),x("ngSubmit",function(){I(e);let o=u(2);return S(o.onSubmit())}),c(1,"div",4)(2,"div",5),_(3,be,2,1,"div",12),f(),c(4,"div",13),C(5,"app-button",14),f()()()}if(r&2){let e=u(2);d("formGroup",e.myForm),p(3),d("ngIf",e.myForm&&e.myForm.controls),p(2),d("buttonType","submit")("buttonClass","ti-btn ti-btn-primary m-0")("disabled",e.api.disabled)("formType",e.pageType)("iconClass","ri-save-line")("loadingIconClass","ri-loader-2-fill")}}function Ie(r,t){if(r&1&&(c(0,"div",9),_(1,xe,6,8,"form",10),f()),r&2){let e=u();p(),d("ngIf",e.formIniatialized)}}var fe=class r{constructor(t,e,i,o,n,s,a,m,g,y,F,ue,h,b){this.api=t;this.date=e;this.spaceRemove=i;this.cdr=o;this.fb=n;this.util=s;this.toastr=a;this.route=m;this.router=g;this.logService=y;this.moduleService=F;this.formValidation=ue;this.dialog=h;this.uploadService=b}filter={};pageType="add";productId;formFields=[];myForm;primaryForm;FORMID=se;moduleFormId=0;moduleId=0;submoduleId=0;moduleName="";originalFormFields=[];skLoading=!1;formIniatialized=!1;fieldTypes=P;originalData={};tableIdId=0;UploadFiles=[];onClick(t){}ngOnInit(){let t=this.moduleService.getSubModuleByName("SFA","Expense"),e=this.moduleService.getFormById("SFA","Expense",this.FORMID.ID.ExpenseFormData),i=this.moduleService.getTableById("SFA","Expense",this.FORMID.ID.ExpenseTableData);t&&(this.moduleId=t.module_id,this.submoduleId=t.sub_module_id,this.moduleName=t.title),e&&(this.moduleFormId=e.form_id,this.getFormData()),i&&(this.tableIdId=i.table_id)}getFormData(){this.skLoading=!0,this.api.post({form_id:this.moduleFormId,platform:"web"},"form-builder/read").subscribe(t=>{t.statusCode==200&&(t?.data?.form_data&&(this.originalFormFields=JSON.parse(JSON.stringify(t.data.form_data))),this.formFields=t.data.form_data,this.skLoading=!1,this.formFields.forEach(e=>{this.util.createValidation(e)}),this.initializeForm())})}initializeForm(){this.getLoginType(),this.myForm=this.fb.group({}),this.formFields.forEach(t=>{let e=this.formValidation.getValidators(t)||[];t.min_date===!0&&(t.min_period==="today"&&(t.min_period="last2days",t.min_period=new Date,t.min_period.setDate(t.min_period.getDate()-2)),e.push(v.minDate(new Date(t.min_period)))),t.max_date===!0&&(t.max_period==="today"&&(t.max_period=new Date,t.max_period.setDate(t.max_period.getDate()+2)),e.push(v.maxDate(new Date(t.max_period)))),t.control=this.fb.control("",this.formValidation.getValidators(t)),this.myForm.addControl(t.name,t.control)}),this.myForm.setValidators(v.startToEndDateValidator("start_date","end_date")),this.formIniatialized=!0,this.productId}getOptions(t){this.api.post({user_id:t},"expense/expense-config").subscribe(e=>{if(e.statusCode===200){for(let i=0;i<this.formFields.length;i++)this.formFields[i].name==="expense_type"&&(this.formFields[i].options=e.data);for(let i=0;i<this.originalFormFields.length;i++)this.originalFormFields[i].name==="expense_type"&&(this.originalFormFields[i].options=e.data)}})}getLoginType(){this.api.post({page:1},"user/read-dropdown").subscribe(t=>{if(t.statusCode==200)for(let e=0;e<this.formFields.length;e++)this.formFields[e].name==="user_name"&&(this.formFields[e].options=t.data)})}getDependencyUpdate(t){if(t.is_child_dependency){let e,i,o;if(t.key_source==="default"){let n=t.options.find(s=>s.value===t.value);e=n?n.label:null}t.child_dependency.forEach(n=>{let s=this.formFields.find(a=>a.name===n.child_field_name);if(s){i=s.name;let a=n.child_field_option.find(m=>m.parent_field_value===e);o=a?a.label:null}}),i&&this.api.post({child_field_name:i,parent_field_value:e},"form-builder/read-dependency").subscribe(n=>{if(n?.statusCode===200&&n?.data){let s=this.formFields.find(a=>a.name===i);s&&(s.options=n.data)}})}}onSubmit(){this.formFields.forEach(t=>{(t.is_child_show===!1||t.is_show===!1)&&(this.myForm.get(t.name)?.clearValidators(),this.myForm.get(t.name)?.updateValueAndValidity())}),this.myForm.valid?(this.api.disabled=!0,this.UploadFiles.length>0?this.UploadFiles.forEach(t=>{let e=t.file.map(i=>{let o=new FormData;return o.append("file",i,i.name),o.append("label",t.label),this.api.uploadFile(o,"s3/uploadsingle").toPromise()});e.length&&Promise.all(e).then(i=>console.log("All files uploaded successfully:",i)).catch(i=>console.error("Error uploading files:",i)),Promise.all(e).then(i=>{let o=[];for(let n=0;n<i.length;n++)o.push({file:i[n].fullPath,label:i[n].label,id:n+1});this.handleSuccess(o)}).catch(i=>{})}):this.handleSuccess([])):this.formValidation.markFormGroupTouched(this.myForm)}handleSuccess(t){this.myForm.addControl("files",this.fb.control(t));let e={primaryFields:{form_data:{}}};this.formFields.forEach(i=>{i.name&&this.myForm.value.hasOwnProperty(i.name)&&(i.read_only===!1&&i.key_source!=="custom"&&(e.primaryFields[i.name]=this.myForm.value[i.name]),i.key_source==="custom"&&(e.primaryFields.form_data[i.name]=this.myForm.value[i.name]),i.type===this.fieldTypes.UPLOAD&&delete e.primaryFields.form_data[i.name])}),e.primaryFields=this.date.formatDatesInObject(e.primaryFields),e.primaryFields.form_data.files=this.myForm.value.files,this.api.post(e.primaryFields,"expense/create").subscribe(i=>{i.statusCode===200&&(this.api.disabled=!1,this.router.navigate(["/apps/sfa/expense-list"]),this.toastr.success(i.message,"","toast-top-right"))},i=>{this.api.disabled=!1,this.toastr.error("Error creating Expense request","","toast-top-right"),console.error("Error:",i)})}onResetDependentFields(t){this.formFields[t].child_dependency.length!=0&&this.formFields[t].child_dependency.map(e=>{let i=this.formFields.findIndex(o=>o.name===e.child_field_name);i!==-1&&(this.myForm.controls[e.child_field_name].reset(),this.formFields[i].value=""),this.onResetDependentFields(i)})}onFieldChange(t,e){if(e.type==this.fieldTypes.SINGLE_SELECT||e.type==this.fieldTypes.MULTI_SELECT||e.type==this.fieldTypes.RADIO_SELECT||e.type==this.fieldTypes.CHECKBOX_SELECT||e.type==this.fieldTypes.DATE||e.type==this.fieldTypes.TIME||e.type==this.fieldTypes.UPLOAD)if(e.type==this.fieldTypes.SINGLE_SELECT){if(e.control.setValue(t),e.value=t.label,e.key_name_required===!0){let i=e.options.findIndex(n=>n.value===t),o;i!==-1&&(o=e.options[i].label,this.formFields.forEach(n=>{n.name===n.key_name&&this.myForm.controls[n.name].setValue(o)}))}}else e.control.setValue(t);if(e.type===this.fieldTypes.DATE_RANGE){let i={from:t.from,to:t.to};this.myForm.controls[e.name].setValue(i)}if(e.name==="product_code"&&t.length>=3&&this.checkDuplicate(e.api_path,t),e.name==="user_name"){this.getOptions(t);let i=e.options.findIndex(o=>o.value===t);if(i!==-1){let o=e.options[i].label,n=e.options[i].value;this.myForm.controls.user_name.setValue(o),this.myForm.controls.user_id.setValue(n)}}if(e.type===this.fieldTypes.UPLOAD){for(let i=0;i<this.UploadFiles.length;i++)this.UploadFiles[i].label===e.label&&this.UploadFiles.splice(i,1);this.UploadFiles.push({label:e.label,file:t})}if(e.is_child_dependency===!0){let i=e.options.findIndex(o=>o.value===t);i!==-1&&(e.type===this.fieldTypes.SINGLE_SELECT&&e.key_source==="default"?(e.value=e.options[i].value,this.getDependencyUpdate(e)):(e.value=e.options[i].label,this.getDependencyUpdate(e)))}if(e.is_child_dependency){let i=this.formFields.findIndex(o=>o.name==e.name);this.onResetDependentFields(i);for(let o=i;o<=this.formFields.length-1;o++){let s=this.formFields[o].options?.find(a=>this.spaceRemove.formatString(a.value)===this.spaceRemove.formatString(this.formFields[o].value))?.label||"";for(let a=0;a<=this.formFields[o].child_dependency.length-1;a++){let m=!1,g=this.formFields[o].child_dependency[a];if(g.visibilty==="Direct"&&(g.parent_field_value===s||g.child_field_option.length===0&&this.formFields[o].is_child_show)&&(m=!0),this.formFields[o].child_dependency[a].visibilty==="Option"){let F=this.formFields.findIndex(h=>h.name==this.formFields[o].child_dependency[a].child_field_name);if(F!==-1&&this.formFields[F].type===this.fieldTypes.SHORT_TEXT&&this.formFields[o].value&&(m=!0,this.formFields[F].is_child_show=m),this.formFields[o].child_dependency[a].child_field_option.findIndex(h=>h.parent_field_value==s&&h.parent_field_name==this.formFields[o].name)!==-1){m=!0;let h=this.formFields.findIndex(b=>b.name==this.formFields[o].child_dependency[a].child_field_name);this.formFields[h].options=this.formFields[o].child_dependency[a].child_field_option.filter(b=>b.parent_field_name==this.formFields[o].name&&b.parent_field_value==s)}}let y=this.formFields.findIndex(F=>F.name==this.formFields[o].child_dependency[a].child_field_name);y!==-1&&(this.formFields[y].is_child_show=m)}}}}checkDuplicate(t,e){this.api.post({product_code:e},t).subscribe(i=>{i===!1?this.api.isDuplicate=!0:this.api.isDuplicate=!1})}static \u0275fac=function(e){return new(e||r)(l(Q),l(ie),l(pe),l(L),l($),l(K),l(B),l(j),l(G),l(le),l(Y),l(ne),l(Z),l(de))};static \u0275cmp=O({type:r,selectors:[["app-expense-add"]],inputs:{formFields:"formFields"},decls:3,vars:6,consts:[["dynamicForm",""],[3,"buttonClick","title","title1","activeitem"],["class","box",4,"ngIf"],["class","xl:col-span-12 col-span-12",4,"ngIf"],[1,"box"],[1,"p-4"],[1,"grid","grid-cols-12","gap-x-6"],["class","xl:col-span-3 col-span-12 mb-4",4,"ngFor","ngForOf"],[1,"xl:col-span-3","col-span-12","mb-4"],[1,"xl:col-span-12","col-span-12"],[3,"formGroup","ngSubmit",4,"ngIf"],[3,"ngSubmit","formGroup"],["class","grid grid-cols-12 gap-x-6",4,"ngIf"],[1,"box-footer","border-t","border-block-start-dashed","sm:flex","justify-end"],[3,"buttonType","buttonClass","disabled","formType","iconClass","loadingIconClass"],[4,"ngFor","ngForOf"],[3,"class",4,"ngIf"],[3,"valueChange","field","form"]],template:function(e,i){e&1&&(c(0,"app-page-header",1),x("buttonClick",function(n){return i.onClick(n)}),f(),_(1,Fe,4,2,"div",2)(2,Ie,2,1,"div",3)),e&2&&(d("title","SFA Modules")("title1",E(5,he))("activeitem","Expense Add"),p(),d("ngIf",i.skLoading),p(),d("ngIf",!i.skLoading))},dependencies:[ae,w,U,z,q,H,me,ce,W,re,te,J,oe,X,ee,N],encapsulation:2})};export{fe as ExpenseAddComponent};
