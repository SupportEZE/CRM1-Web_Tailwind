import{a as ue}from"./chunk-GXF7AAOQ.js";import{a as me}from"./chunk-PU6S26UW.js";import{a as fe}from"./chunk-ZON5AR26.js";import"./chunk-LGZVJJDX.js";import{a as ce}from"./chunk-54KZ5YIV.js";import"./chunk-SQZ3YN6N.js";import"./chunk-CIBZCVJQ.js";import{a as le}from"./chunk-OTFCGVEU.js";import{a as de}from"./chunk-HPLI5COI.js";import"./chunk-DUVWFXSE.js";import"./chunk-OEHD5D2Y.js";import{a as pe}from"./chunk-GLWQGYBC.js";import{a as Z}from"./chunk-DC4QM32I.js";import{C as se,F as ae,c as Y,f as te,k as oe,n as ne,v as re}from"./chunk-VHE3PQ3O.js";import{C as P,D as B,H as $,M as H,Qa as ee,V as J,W as K,X,Y as Q,Z as W,hb as ie,l as j,w as G}from"./chunk-GYDYF5F3.js";import{K as R,M as z,f as U,g as k,n as w,t as N}from"./chunk-PD5VTTIY.js";import{Aa as S,Ba as C,Hb as O,Ob as h,Yc as x,_b as l,cc as q,ed as L,fd as V,kc as p,lc as c,mc as T,nc as M,oc as A,qc as E,rb as m,sb as d,wc as v,yc as f}from"./chunk-2NSPOFEK.js";import"./chunk-EU2KAMEK.js";import{a as I,i as D}from"./chunk-66YHNWRR.js";var ye=()=>["Enquiry"],Fe=()=>[];function ge(s,i){s&1&&(p(0,"div",8),T(1,"app-skeleton"),c())}function ve(s,i){s&1&&(p(0,"div",4)(1,"div",5)(2,"div",6),h(3,ge,2,0,"div",7),c()()()),s&2&&(m(3),l("ngForOf",x(1,Fe).constructor(10)))}function be(s,i){if(s&1){let e=E();p(0,"div")(1,"app-form-field",17,0),v("valueChange",function(n){S(e);let t=f().$implicit,a=f(4);return C(a.onFieldChange(n,t))}),c()()}if(s&2){let e=f().$implicit,o=f(4);q("mb-4 ",e.class_name,""),m(),l("field",e)("form",o.myForm)}}function Ie(s,i){if(s&1&&(M(0),h(1,be,3,5,"div",16),A()),s&2){let e=i.$implicit;m(),l("ngIf",e.is_show===!0&&(e.is_parent_dependency===!1||e.is_child_show===!0))}}function Se(s,i){if(s&1&&(p(0,"div",6),h(1,Ie,2,1,"ng-container",15),c()),s&2){let e=f(3);m(),l("ngForOf",e.formFields)}}function Ce(s,i){if(s&1){let e=E();p(0,"form",11),v("ngSubmit",function(){S(e);let n=f(2);return C(n.onSubmit())}),p(1,"div",4)(2,"div",5),h(3,Se,2,1,"div",12),c(),p(4,"div",13),T(5,"app-button",14),c()()()}if(s&2){let e=f(2);l("formGroup",e.myForm),m(3),l("ngIf",e.myForm&&e.myForm.controls),m(2),l("buttonType","submit")("buttonClass","ti-btn ti-btn-primary m-0")("disabled",e.api.disabled)("formType",e.pageType)("iconClass","ri-save-line")("loadingIconClass","ri-loader-2-fill")}}function Te(s,i){if(s&1&&(p(0,"div",9),h(1,Ce,6,8,"form",10),c()),s&2){let e=f();m(),l("ngIf",e.formIniatialized)}}var he=class s{constructor(i,e,o,n,t,a,r,u,F,b,_,_e){this.moduleService=i;this.api=e;this.util=o;this.formValidation=n;this.fb=t;this.dialog=a;this.route=r;this.router=u;this.logService=F;this.toastr=b;this.spaceRemove=_;this.uploadService=_e}skLoading=!1;FORMID=de;submodule;moduleFormId=0;moduleTableId=0;UploadFiles=[];originalFormFields=[];formGroup=new B({});formFields=[];myForm;primaryForm;formIniatialized=!1;pageType="add";originalData={};fieldTypes=j;DetailId;ngOnInit(){let i=this.moduleService.getSubModuleByName("SFA","Enquiry"),e=this.moduleService.getFormById("SFA","Enquiry",this.FORMID.ID.EnquiryForm);i&&(this.submodule=i),e&&(this.moduleFormId=e.form_id,this.getFormData()),this.route.paramMap.subscribe(o=>{if(o){this.DetailId=o.get("id");let n=o.get("edit");this.pageType=n||"add"}})}getFormData(){this.skLoading=!0,this.api.post({form_id:this.moduleFormId,platform:"web"},"form-builder/read").subscribe(i=>{i.statusCode==200&&(i?.data?.form_data&&(this.originalFormFields=JSON.parse(JSON.stringify(i.data.form_data))),this.formFields=i.data.form_data,this.skLoading=!1,this.formFields.forEach(e=>{this.util.createValidation(e)}),this.initializeForm())})}initializeForm(){this.getUserList(),this.myForm=this.fb.group({}),this.formFields.forEach(i=>{i.api_path&&this.getOptions(i.name,i.api_path),i.control=this.fb.control("",this.formValidation.getValidators(i)),this.myForm.addControl(i.name,i.control)}),this.formIniatialized=!0,this.DetailId&&this.getDetail()}getDetail(){this.api.post({_id:this.DetailId},"enquiry/detail").subscribe(i=>{if(i.statusCode===200){let e;e=i.data,this.originalData=I(I({},e),e.form_data),delete this.originalData.form_data;let o=Object.keys(this.originalData),n=this.formFields.filter(t=>o.includes(t.name)&&(t.type===this.fieldTypes.SINGLE_SELECT||t.type===this.fieldTypes.MULTI_SELECT));if(this.myForm.patchValue(this.originalData),n.length>0)for(let t=0;t<n.length;t++){let a=n[t].name;this.myForm.controls[a]&&this.myForm.controls[a].setValue(this.originalData[a]);for(let r=0;r<this.formFields.length;r++)this.formFields[r].name===a&&this.originalData[a]&&(this.formFields[r].is_child_show=!0,this.formFields[r].value=this.originalData[a],this.getDependencyUpdate(this.formFields[r]))}}})}onFieldChange(i,e){if(console.log(e.is_child_dependency,"field.is_child_dependency"),e.type==this.fieldTypes.SINGLE_SELECT||e.type==this.fieldTypes.MULTI_SELECT||e.type==this.fieldTypes.RADIO_SELECT||e.type==this.fieldTypes.CHECKBOX_SELECT||e.type==this.fieldTypes.DATE||e.type==this.fieldTypes.TIME||e.type==this.fieldTypes.UPLOAD){if(e.key_name_required===!0){let o=e.options.findIndex(t=>t.value===i),n;o!==-1&&(n=e.options[o].label,this.formFields.forEach(t=>{t.name===e.key_name&&this.myForm.controls[t.name].setValue(n)}))}e.type==this.fieldTypes.SINGLE_SELECT&&e.key_source=="custom"||e.type==this.fieldTypes.MULTI_SELECT&&e.key_source=="custom"?(e.control.setValue(i),e.value=i.label):e.control.setValue(i)}if(e.type===this.fieldTypes.DATE_RANGE){let o={from:i.from,to:i.to};this.myForm.controls[e.name].setValue(o)}if(e.name==="enquiry_code"&&i.length>=3&&this.checkDuplicate(e.api_path,i),e.type===this.fieldTypes.UPLOAD){for(let o=0;o<this.UploadFiles.length;o++)this.UploadFiles[o].label===e.label&&this.UploadFiles.splice(o,1);this.UploadFiles.push({label:e.label,file:i})}if(e.is_child_dependency===!0){let o=e.options.findIndex(n=>n.value===i);o!==-1&&(e.type===this.fieldTypes.SINGLE_SELECT&&e.key_source==="default"?(e.value=e.options[o].value,this.getDependencyUpdate(e)):(e.value=e.options[o].label,this.getDependencyUpdate(e)))}if(e.is_child_dependency){let o=this.formFields.findIndex(n=>n.name==e.name);this.onResetDependentFields(o);for(let n=o;n<=this.formFields.length-1;n++){let a=this.formFields[n].options?.find(r=>this.spaceRemove.formatString(r.value)===this.spaceRemove.formatString(this.formFields[n].value))?.label||"";for(let r=0;r<=this.formFields[n].child_dependency.length-1;r++){let u=!1,F=this.formFields[n].child_dependency[r];if(F.visibilty==="Direct"&&(F.parent_field_value===a||F.child_field_option.length===0&&this.formFields[n].is_child_show)&&(u=!0),this.formFields[n].child_dependency[r].visibilty==="Option"){let _=this.formFields.findIndex(y=>y.name==this.formFields[n].child_dependency[r].child_field_name);if(_!==-1&&this.formFields[_].type===this.fieldTypes.SHORT_TEXT&&this.formFields[n].value&&(u=!0,this.formFields[_].is_child_show=u),this.formFields[n].child_dependency[r].child_field_option.findIndex(y=>y.parent_field_value==a&&y.parent_field_name==this.formFields[n].name)!==-1){u=!0;let y=this.formFields.findIndex(g=>g.name==this.formFields[n].child_dependency[r].child_field_name);this.formFields[y].options=this.formFields[n].child_dependency[r].child_field_option.filter(g=>g.parent_field_name==this.formFields[n].name&&g.parent_field_value==a)}}let b=this.formFields.findIndex(_=>_.name==this.formFields[n].child_dependency[r].child_field_name);b!==-1&&(this.formFields[b].is_child_show=u)}}}}getOptions(i,e,o){return D(this,null,function*(){try{let n=yield this.api.post({dropdown_name:i,module_id:this.submodule.sub_module_id||this.submodule.module_id,dropdown_option:o},e).toPromise();n?.statusCode===200&&(this.formFields.forEach(t=>{t.name===i&&(t.options=n.data,o&&n.data.length>0&&(t.is_child_show=!0))}),this.originalFormFields.forEach(t=>{t.name===i&&(t.options=n.data)}))}catch(n){console.error("Error fetching options:",n)}})}getUserList(){this.api.post({page:1},"user/read-dropdown").subscribe(i=>{if(i.statusCode==200)for(let e=0;e<this.formFields.length;e++)this.formFields[e].name==="assigned_to_user_id"&&(this.formFields[e].options=i.data)})}getDependencyUpdate(i){if(i.is_child_dependency){let e,o,n;if(i.key_source==="default"){let t=i.options.find(a=>a.value===i.value);e=t?t.label:null}i.child_dependency.forEach(t=>{let a=this.formFields.find(r=>r.name===t.child_field_name);if(a){o=a.name;let r=t.child_field_option.find(u=>u.parent_field_value===e);n=r?r.label:null}}),o&&this.api.post({child_field_name:o,parent_field_value:e},"form-builder/read-dependency").subscribe(t=>{if(t?.statusCode===200&&t?.data){let a=this.formFields.find(r=>r.name===o);a&&(a.options=t.data)}})}}onResetDependentFields(i){this.formFields[i].child_dependency.length!=0&&this.formFields[i].child_dependency.map(e=>{let o=this.formFields.findIndex(n=>n.name===e.child_field_name);o!==-1&&(this.myForm.controls[e.child_field_name].reset(),this.formFields[o].value=""),this.onResetDependentFields(o)})}onSubmit(){if(this.formFields.forEach(i=>{(i.is_child_show===!1||i.is_show===!1)&&(this.myForm.get(i.name)?.clearValidators(),this.myForm.get(i.name)?.updateValueAndValidity())}),console.log(this.myForm.value,"this.myForm"),this.myForm.valid){this.api.disabled=!0;let i={primaryFields:{form_data:{}}};this.formFields.forEach(t=>{t.name&&this.myForm.value.hasOwnProperty(t.name)&&(t.read_only===!1&&t.key_source!=="custom"&&(i.primaryFields[t.name]=this.myForm.value[t.name]),t.key_source==="custom"&&(i.primaryFields.form_data[t.name]=this.myForm.value[t.name]),t.type===this.fieldTypes.UPLOAD&&delete i.primaryFields.form_data[t.name])}),i.primaryFields.form_data.files=this.myForm.value.files;let e=this.pageType==="edit";if(e&&(i.primaryFields._id=this.DetailId,this.logService.logActivityOnUpdate(e,this.originalData,this.myForm.value,this.submodule.module_id,this.submodule.title,"update",this.originalData._id||null,()=>{},this.submodule.module_type)&&this.UploadFiles.length===0)){this.api.disabled=!1,this.toastr.warning("No changes detected","","toast-top-right");return}let o=e?"patch":"post",n=e?"enquiry/update":"enquiry/create";this.api[o](i.primaryFields,n).subscribe(t=>{t.statusCode===200&&(this.UploadFiles.length>0?(this.api.disabled=!0,this.uploadService.uploadFile(t.data.inserted_id,"enquiry",this.UploadFiles,"Enquiry Images",this.submodule,"/apps/sfa/enquiry-list")):(this.api.disabled=!1,this.router.navigate([e?`/apps/sfa/enquiry-list/enquiry-detail/${this.DetailId}`:"/apps/sfa/enquiry-list"]),this.toastr.success(t.message,"","toast-top-right")))})}else{this.toastr.error("Form Is Invalid","","toast-top-right"),this.formValidation.markFormGroupTouched(this.myForm);let i=Object.keys(this.myForm.controls).filter(e=>this.myForm.get(e)?.invalid);console.warn("Invalid fields:",i)}}openModal(i){this.dialog.open(fe,{data:{lastPage:"enquiry",form_Fields:this.originalFormFields,moduleFormId:this.moduleFormId,moduleId:this.submodule.module_id,moduleName:this.submodule.title,moduleData:this.submodule}}).afterClosed().subscribe(o=>{o===!0&&this.getFormData()})}checkDuplicate(i,e){this.api.post({enquiry_code:e},i).subscribe(o=>{o===!1?this.api.isDuplicate=!0:this.api.isDuplicate=!1})}static \u0275fac=function(e){return new(e||s)(d(Z),d(W),d(Q),d(re),d(J),d(ee),d(R),d(z),d(le),d(G),d(ce),d(me))};static \u0275cmp=O({type:s,selectors:[["app-enquiry-add"]],inputs:{formFields:"formFields"},decls:4,vars:14,consts:[["dynamicForm",""],[3,"buttonClick1","title","title1","activeitem","buttonText","icon","buttonText1","icon1","btnShow1","buttonValue1"],["class","box",4,"ngIf"],["class","xl:col-span-12 col-span-12",4,"ngIf"],[1,"box"],[1,"p-4"],[1,"grid","grid-cols-12","gap-x-6"],["class","xl:col-span-3 col-span-12 mb-4",4,"ngFor","ngForOf"],[1,"xl:col-span-3","col-span-12","mb-4"],[1,"xl:col-span-12","col-span-12"],[3,"formGroup","ngSubmit",4,"ngIf"],[3,"ngSubmit","formGroup"],["class","grid grid-cols-12 gap-x-6",4,"ngIf"],[1,"box-footer","border-t","border-block-start-dashed","sm:flex","justify-end"],[3,"buttonType","buttonClass","disabled","formType","iconClass","loadingIconClass"],[4,"ngFor","ngForOf"],[3,"class",4,"ngIf"],[3,"valueChange","field","form"]],template:function(e,o){e&1&&(p(0,"app-page-header",1),L(1,"titlecase"),v("buttonClick1",function(t){return o.openModal(t)}),c(),h(2,ve,4,2,"div",2)(3,Te,2,1,"div",3)),e&2&&(l("title","SFA Ozone")("title1",x(13,ye))("activeitem",V(1,11,o.pageType)+" Enquiry")("buttonText","Filter")("icon","filter_list")("buttonText1","Form Config")("icon1","settings")("btnShow1",!0)("buttonValue1",""),m(2),l("ngIf",o.skLoading),m(),l("ngIf",!o.skLoading))},dependencies:[ae,U,k,$,P,H,pe,ue,Y,se,w,te,oe,K,ne,X,ie,N],encapsulation:2})};export{he as OzoneEnquiryAddComponent};
