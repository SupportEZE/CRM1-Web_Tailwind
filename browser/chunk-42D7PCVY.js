import{a as fe}from"./chunk-GXF7AAOQ.js";import{a as ce}from"./chunk-PU6S26UW.js";import{a as ue}from"./chunk-ZON5AR26.js";import"./chunk-LGZVJJDX.js";import{a as he}from"./chunk-54KZ5YIV.js";import"./chunk-SQZ3YN6N.js";import"./chunk-CIBZCVJQ.js";import{a as le}from"./chunk-OTFCGVEU.js";import{a as me}from"./chunk-HPLI5COI.js";import"./chunk-DUVWFXSE.js";import"./chunk-OEHD5D2Y.js";import{a as pe}from"./chunk-GLWQGYBC.js";import{a as Z}from"./chunk-DC4QM32I.js";import{C as ae,F as de,c as Y,f as oe,k as se,n as ne,v as re}from"./chunk-VHE3PQ3O.js";import{C as $,H,M as q,Qa as te,V as J,W as K,X,Y as Q,Z as W,da as ee,hb as ie,l as B,w as z}from"./chunk-GYDYF5F3.js";import{K as P,M as G,f as U,g as w,n as N,t as j}from"./chunk-PD5VTTIY.js";import{Aa as v,Ba as b,Hb as E,Ob as f,Yc as A,Zc as k,_b as m,cc as V,ed as O,fd as R,kc as p,lc as h,mc as S,nc as L,oc as M,qc as x,rb as c,sb as d,wc as C,yc as l}from"./chunk-2NSPOFEK.js";import"./chunk-EU2KAMEK.js";import{a as I,i as D}from"./chunk-66YHNWRR.js";var ge=a=>[a],Fe=()=>[];function ve(a,t){a&1&&(p(0,"div",8),S(1,"app-skeleton"),h())}function be(a,t){a&1&&(p(0,"div",4)(1,"div",5)(2,"div",6),f(3,ve,2,0,"div",7),h()()()),a&2&&(c(3),m("ngForOf",A(1,Fe).constructor(10)))}function Ce(a,t){if(a&1){let e=x();p(0,"div")(1,"app-form-field",17,0),C("valueChange",function(s){v(e);let o=l().$implicit,r=l(4);return b(r.onFieldChange(s,o))})("searchChanged",function(s){v(e);let o=l().$implicit,r=l(4);return b(o.search?r.onSearch(s,o):"")}),h()()}if(a&2){let e=l().$implicit,i=l(4);V("mb-4 ",e.class_name,""),c(),m("field",e)("form",i.myForm)}}function Te(a,t){if(a&1&&(L(0),f(1,Ce,3,5,"div",16),M()),a&2){let e=t.$implicit;c(),m("ngIf",e.is_show===!0&&(e.is_parent_dependency===!1||e.is_child_show===!0))}}function Ie(a,t){if(a&1&&(p(0,"div",6),f(1,Te,2,1,"ng-container",15),h()),a&2){let e=l(3);c(),m("ngForOf",e.formFields)}}function Se(a,t){if(a&1){let e=x();p(0,"form",11),C("ngSubmit",function(){v(e);let s=l(2);return b(s.onSubmit())}),p(1,"div",4)(2,"div",5),f(3,Ie,2,1,"div",12),h(),p(4,"div",13),S(5,"app-button",14),h()()()}if(a&2){let e=l(2);m("formGroup",e.myForm),c(3),m("ngIf",e.myForm&&e.myForm.controls),c(2),m("buttonType","submit")("buttonClass","ti-btn ti-btn-primary m-0")("disabled",e.api.disabled)("formType",e.pageType)("iconClass","ri-save-line")("loadingIconClass","ri-loader-2-fill")}}function xe(a,t){if(a&1&&(p(0,"div",9),f(1,Se,6,8,"form",10),h()),a&2){let e=l();c(),m("ngIf",e.formIniatialized)}}var _e=class a{constructor(t,e,i,s,o,r,n,u,g,T,_,ye){this.spaceRemove=t;this.toastr=e;this.util=i;this.api=s;this.dialog=o;this.route=r;this.router=n;this.logService=u;this.moduleService=g;this.formValidation=T;this.uploadService=_;this.fb=ye}submodule;FORMID=me;moduleFormId=0;customerType;customerLoginType;customerLoginTypeId;customerId;formFields=[];myForm;formIniatialized=!1;fieldTypes=B;UploadFiles=[];originalFormFields=[];skLoading=!1;uploadedImages=[];binaryFiles=[];pageType="add";originalData={};customerTypeId;ngOnInit(){this.route.paramMap.subscribe(s=>{if(s){this.customerLoginType=s.get("login_type"),this.customerLoginTypeId=s.get("login_type_id"),this.customerType=s.get("type_name"),this.customerTypeId=s.get("type_id"),this.customerId=s.get("id");let o=s.get("edit");this.pageType=o||"add"}});let t=this.moduleService.getModuleByName("Customers");this.customerType=this.customerType?.replace(/_/g," ")||"";let e=t?.children?.find(s=>s.title===this.customerType),i;e&&e.forms?.length&&(i=e.forms[0]),t&&(this.submodule=t),i&&(this.submodule.form_id=i.form_id,this.moduleFormId=i.form_id,this.getFormData())}initializeForm(){this.myForm=this.fb.group({}),this.formFields.forEach(t=>{t.api_path&&this.getOptions(t.name,t.api_path,t.api_payload,t.api_payload_key),t.control=this.fb.control("",this.formValidation.getValidators(t)),this.myForm.addControl(t.name,t.control),this.customerLoginType==="Influencer"&&t.name==="customer_code"&&(t.is_show=!1,this.myForm.get(t.name)?.clearValidators(),this.myForm.get(t.name)?.updateValueAndValidity())}),this.formIniatialized=!0,this.customerId&&this.getCustomerDetail()}getOptions(t,e,i,s){return D(this,null,function*(){console.log(t,"name");try{let o={dropdown_name:t,module_id:this.submodule.sub_module_id||this.submodule.module_id};i&&s&&(o[s]=i);let r=yield this.api.post(o,e).toPromise();r?.statusCode===200&&(this.formFields.forEach(n=>{n.name===t&&(n.options=r.data)}),this.originalFormFields.forEach(n=>{n.name===t&&(n.options=r.data)}))}catch(o){console.error("Error fetching options:",o)}})}getCustomerDetail(){this.skLoading=!0,this.api.post({_id:this.customerId},"customer/detail").subscribe(t=>{if(t.statusCode===200){this.skLoading=!1;let e;e=t.data.basic_detail,this.originalData=I(I({},e),e.form_data),this.originalData.state&&this.getDistrict(this.originalData.state),delete this.originalData.form_data;let i=Object.keys(this.originalData),s=this.formFields.filter(o=>i.includes(o.name)&&(o.type===this.fieldTypes.SINGLE_SELECT||o.type===this.fieldTypes.MULTI_SELECT));if(this.myForm.patchValue(this.originalData),s.length>0)for(let o=0;o<s.length;o++){this.onFieldChange(s[o].control?.value,s[o]);let r=s[o].name;this.myForm.controls[r]&&this.myForm.controls[r].setValue(this.originalData[r]);for(let n=0;n<this.formFields.length;n++)this.formFields[n].name===r&&this.originalData[r]&&(this.formFields[n].is_child_show=!0,this.formFields[n].value=this.originalData[r],this.getDependencyUpdate(this.formFields[n]))}}})}onResetDependentFields(t){this.formFields[t].child_dependency.length!=0&&this.formFields[t].child_dependency.map(e=>{let i=this.formFields.findIndex(s=>s.name===e.child_field_name);i!==-1&&(this.myForm.controls[e.child_field_name].reset(),this.formFields[i].value=""),this.onResetDependentFields(i)})}onFieldChange(t,e){if(e.type==this.fieldTypes.SINGLE_SELECT||e.type==this.fieldTypes.MULTI_SELECT||e.type==this.fieldTypes.RADIO_SELECT||e.type==this.fieldTypes.CHECKBOX_SELECT||e.type==this.fieldTypes.DATE||e.type==this.fieldTypes.TIME||e.type==this.fieldTypes.UPLOAD)if(e.type==this.fieldTypes.SINGLE_SELECT){if(e.control.setValue(t),e.value=t.label,e.key_name_required===!0){let i=e.options.findIndex(o=>o.value===t),s;i!==-1&&(s=e.options[i].label,this.formFields.forEach(o=>{o.name===e.key_name&&this.myForm.controls[o.name].setValue(s)}))}}else e.control.setValue(t);if(e.type===this.fieldTypes.DATE_RANGE){let i={from:t.from,to:t.to};this.myForm.controls[e.name].setValue(i)}if((e.name==="mobile"&&t.length==10||e.name==="alt_mobile_no"&&t.length==10)&&this.checkDuplicate(e.api_path,e.name,t),e.type===this.fieldTypes.UPLOAD){for(let i=0;i<this.UploadFiles.length;i++)this.UploadFiles[i].label===e.label&&this.UploadFiles.splice(i,1);Object.assign(t,{image_type:e.label}),this.UploadFiles.push({file:t})}if(e.is_child_dependency===!0){let i=e.options.findIndex(s=>s.value===t);i!==-1&&(e.type===this.fieldTypes.SINGLE_SELECT&&e.key_source==="default"?(e.value=e.options[i].value,this.getDependencyUpdate(e)):(e.value=e.options[i].label,this.getDependencyUpdate(e)))}if(e.name==="state"&&this.getDistrict(t),e.name==="pincode"&&t.length===6&&this.getPostalMaster(t),e.is_child_dependency){let i=this.formFields.findIndex(s=>s.name==e.name);this.onResetDependentFields(i);for(let s=i;s<=this.formFields.length-1;s++){let r=this.formFields[s].options?.find(n=>this.spaceRemove.formatString(n.value)===this.spaceRemove.formatString(this.formFields[s].value))?.label||"";for(let n=0;n<=this.formFields[s].child_dependency.length-1;n++){let u=!1,g=this.formFields[s].child_dependency[n];if(g.visibilty==="Direct"&&(g.parent_field_value===r||g.child_field_option.length===0&&this.formFields[s].is_child_show)&&(u=!0),this.formFields[s].child_dependency[n].visibilty==="Option"){let _=this.formFields.findIndex(y=>y.name==this.formFields[s].child_dependency[n].child_field_name);if(_!==-1&&this.formFields[_].type===this.fieldTypes.SHORT_TEXT&&this.formFields[s].value&&(u=!0,this.formFields[_].is_child_show=u),this.formFields[s].child_dependency[n].child_field_option.findIndex(y=>y.parent_field_value==r&&y.parent_field_name==this.formFields[s].name)!==-1){u=!0;let y=this.formFields.findIndex(F=>F.name==this.formFields[s].child_dependency[n].child_field_name);this.formFields[y].options=this.formFields[s].child_dependency[n].child_field_option.filter(F=>F.parent_field_name==this.formFields[s].name&&F.parent_field_value==r)}}let T=this.formFields.findIndex(_=>_.name==this.formFields[s].child_dependency[n].child_field_name);T!==-1&&(this.formFields[T].is_child_show=u)}}}}onClick(t){}getFormData(){this.skLoading=!0,this.api.post({form_id:this.moduleFormId,platform:"web"},"form-builder/read").subscribe(t=>{t.statusCode==200&&(t?.data?.form_data&&(this.originalFormFields=JSON.parse(JSON.stringify(t.data.form_data))),this.formFields=t.data.form_data,this.skLoading=!1,this.formFields.forEach(e=>{this.util.createValidation(e)}),this.getState(),this.initializeForm())})}getDependencyUpdate(t){if(t.is_child_dependency){let e,i,s;if(t.key_source==="default"){let o=t.options.find(r=>r.value===t.value);e=o?o.label:null}t.child_dependency.forEach(o=>{let r=this.formFields.find(n=>n.name===o.child_field_name);if(r){i=r.name;let n=o.child_field_option.find(u=>u.parent_field_value===e);s=n?n.label:null}}),i&&this.api.post({child_field_name:i,parent_field_value:e},"form-builder/read-dependency").subscribe(o=>{if(o?.statusCode===200&&o?.data){let r=this.formFields.find(n=>n.name===i);r&&(r.options=o.data)}})}}checkDuplicate(t,e,i){let s={[e]:i};this.api.post(s,t).subscribe(o=>{o===!1?this.api.isDuplicate=!0:this.api.isDuplicate=!1})}getState(){this.api.post({},"postal-code/states").subscribe(t=>{if(t.statusCode==200)for(let e=0;e<this.formFields.length;e++)(this.formFields[e].name==="state"||this.formFields[e].name==="holiday_profile"||this.formFields[e].name==="assigned_area")&&(this.formFields[e].options=t.data)})}getDistrict(t){for(let e=0;e<this.formFields.length;e++)this.formFields[e].name==="district"&&(this.formFields[e].options=[]);this.api.post({state:t},"postal-code/districts").subscribe(e=>{if(e.statusCode==200)for(let i=0;i<this.formFields.length;i++)this.formFields[i].name==="district"&&(this.formFields[i].options=e.data)})}getPostalMaster(t){this.api.post({pincode:t},"postal-code/read-using-pincode").subscribe(e=>{if(e.statusCode==200)for(let i=0;i<this.formFields.length;i++)this.formFields[i].name==="state"&&(this.myForm.controls.state.setValue(e.data.state),this.getDistrict(e.data.state)),this.formFields[i].name==="district"&&this.myForm.controls.district.setValue(e.data.district),this.formFields[i].name==="city"&&this.myForm.controls.city.setValue(e.data.city),this.formFields[i].name==="country"&&this.myForm.controls.country.setValue(e.data.country)})}openModal(t){this.dialog.open(ue,{data:{lastPage:"product",form_Fields:this.originalFormFields,moduleFormId:this.moduleFormId,moduleId:this.submodule.module_id,moduleName:this.submodule.title,moduleData:this.submodule}}).afterClosed().subscribe(i=>{i===!0&&this.getFormData()})}onSubmit(){if(this.formFields.forEach(t=>{(t.is_child_show===!1||t.is_show===!1)&&(this.myForm.get(t.name)?.clearValidators(),this.myForm.get(t.name)?.updateValueAndValidity())}),this.myForm.valid){this.api.disabled=!0;let t={primaryFields:{form_data:{}}};this.formFields.forEach(o=>{o.name&&this.myForm.value.hasOwnProperty(o.name)&&(o.read_only===!1&&o.key_source!=="custom"&&(t.primaryFields[o.name]=this.myForm.value[o.name]),o.key_source==="custom"&&(t.primaryFields.form_data[o.name]=this.myForm.value[o.name]),o.type===this.fieldTypes.UPLOAD&&delete t.primaryFields.form_data[o.name])}),this.formValidation.removeEmptyFields(t.primaryFields),t.primaryFields.form_data.files=this.myForm.value.files;let e=this.pageType==="edit";if(e&&(t.primaryFields._id=this.customerId,this.logService.logActivityOnUpdate(e,this.originalData,this.myForm.value,this.submodule.sub_module_id?this.submodule.sub_module_id:this.submodule.module_id,this.submodule.title,"update",this.originalData._id||null,()=>{},this.submodule.module_type)&&this.UploadFiles.length===0)){this.api.disabled=!1,this.toastr.warning("No changes detected","","toast-top-right");return}let i=e?"patch":"post",s=e?"customer/update":"customer/create";t.primaryFields.customer_type_id=this.customerTypeId,t.primaryFields.customer_type_name=this.customerType,this.api[i](t.primaryFields,s).subscribe(o=>{o.statusCode===200&&(this.UploadFiles.length>0?this.uploadService.uploadFile(o.data.inserted_id,"customer",this.UploadFiles,"Profile Picture",this.submodule,"apps/customer/customer-list/"+this.customerLoginType+"/"+this.customerLoginTypeId+"/"+this.customerType+"/"+this.customerTypeId,()=>{},void 0,this.originalData.files):(this.api.disabled=!1,this.router.navigate(["apps/customer/customer-list/"+this.customerLoginType+"/"+this.customerLoginTypeId+"/"+this.customerType+"/"+this.customerTypeId]),this.toastr.success(o.message,"","toast-top-right")))})}else this.toastr.error("Form Is Invalid","","toast-top-right"),this.formValidation.markFormGroupTouched(this.myForm)}onSearch(t,e){let i={module_id:this.submodule.sub_module_id||this.submodule.module_id,page:1,dropdown_name:e.search_payload,filters:{search:t}},s=this.myForm.value.state;s&&(i.state=s),this.api.post(i,e.search_api).subscribe({next:o=>{o.statusCode===200&&(e.options=o.data)}})}static \u0275fac=function(e){return new(e||a)(d(he),d(z),d(Q),d(W),d(te),d(P),d(G),d(le),d(Z),d(re),d(ce),d(J))};static \u0275cmp=E({type:a,selectors:[["app-customer-add"]],inputs:{formFields:"formFields"},decls:4,vars:17,consts:[["dynamicForm",""],[3,"buttonClick","buttonClick1","title","title1","activeitem","buttonText","icon","btnShow","buttonValue","buttonText1","icon1","btnShow1","buttonValue1"],["class","box",4,"ngIf"],["class","xl:col-span-12 col-span-12",4,"ngIf"],[1,"box"],[1,"p-4"],[1,"grid","grid-cols-12","gap-x-6"],["class","xl:col-span-3 col-span-12 mb-4",4,"ngFor","ngForOf"],[1,"xl:col-span-3","col-span-12","mb-4"],[1,"xl:col-span-12","col-span-12"],[3,"formGroup","ngSubmit",4,"ngIf"],[3,"ngSubmit","formGroup"],["class","grid grid-cols-12 gap-x-6",4,"ngIf"],[1,"box-footer","border-t","border-block-start-dashed","sm:flex","justify-end"],[3,"buttonType","buttonClass","disabled","formType","iconClass","loadingIconClass"],[4,"ngFor","ngForOf"],[3,"class",4,"ngIf"],[3,"valueChange","searchChanged","field","form"]],template:function(e,i){e&1&&(p(0,"app-page-header",1),O(1,"titlecase"),C("buttonClick",function(o){return i.onClick(o)})("buttonClick1",function(o){return i.openModal(o)}),h(),f(2,be,4,2,"div",2)(3,xe,2,1,"div",3)),e&2&&(m("title","Customer")("title1",k(15,ge,i.spaceRemove.formatText(i.customerType)))("activeitem",R(1,13,i.pageType)+" "+i.spaceRemove.formatText(i.customerType))("buttonText","Filter")("icon","filter_list")("btnShow",!1)("buttonValue","filter_data")("buttonText1","Form Config")("icon1","settings")("btnShow1",!0)("buttonValue1",""),c(2),m("ngIf",i.skLoading),c(),m("ngIf",!i.skLoading))},dependencies:[de,U,w,H,$,q,pe,fe,Y,ae,N,ee,oe,se,K,ne,X,ie,j],encapsulation:2})};export{_e as CustomerAddComponent};
