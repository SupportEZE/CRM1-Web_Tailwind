import{a as ie}from"./chunk-PU6S26UW.js";import{a as ae}from"./chunk-SQZ3YN6N.js";import"./chunk-OTFCGVEU.js";import{a as z}from"./chunk-CNF4GSI7.js";import{a as H}from"./chunk-OEHD5D2Y.js";import{a as oe}from"./chunk-GLWQGYBC.js";import{a as Y}from"./chunk-DC4QM32I.js";import{C as ee,F as te,c as Q,g as W,h as $,j as J,k as K,v as X,w as Z}from"./chunk-VHE3PQ3O.js";import{A as m,B as E,C as N,H as M,M as O,P as B,V as j,X as L,Z as G,hb as U,o as y,w as D}from"./chunk-GYDYF5F3.js";import{K as R,M as q,Q as A,f as V,g as T,t as w}from"./chunk-PD5VTTIY.js";import{Aa as u,Ba as h,Hb as P,Mc as p,Nc as v,Ob as b,Yc as F,_b as l,f as I,kc as r,lc as n,mc as f,qc as S,rb as s,sb as _,wc as g,yc as c}from"./chunk-2NSPOFEK.js";import"./chunk-EU2KAMEK.js";import{a as C,b as x}from"./chunk-66YHNWRR.js";var se=()=>["Purchase"],ne=()=>[];function le(d,i){d&1&&(r(0,"div",7),f(1,"app-skeleton"),n())}function de(d,i){d&1&&(r(0,"div",3)(1,"div",4)(2,"div",5),b(3,le,2,0,"div",6),n()()()),d&2&&(s(3),l("ngForOf",F(1,ne).constructor(10)))}function ce(d,i){if(d&1){let e=S();r(0,"tr")(1,"td",39),p(2),n(),r(3,"td"),p(4),n(),r(5,"td",40),p(6),n(),r(7,"td",41),p(8),n(),r(9,"td",42)(10,"div",43)(11,"app-icon-button",44),g("clickEvent",function(){let o=u(e).index,a=c(3);return h(a.delete(o))}),n()()()()}if(d&2){let e=i.$implicit,t=i.index;s(2),v(t+1),s(2),v(e.label?e.label:"---"),s(2),v(e.qty?e.qty:"0"),s(2),v(e.point_value?e.point_value:"0"),s(3),l("icon","ri-delete-bin-line")("buttonClass","ti-btn btn-wave product-btn ti-btn-sm ti-btn-soft-danger waves-effect waves-light")}}function me(d,i){if(d&1&&(r(0,"div",8)(1,"div",30)(2,"spk-reusable-tables",31),b(3,ce,12,6,"tr",32),n()(),r(4,"table",33)(5,"tbody")(6,"tr",34)(7,"td",35)(8,"div",36),p(9,"Total Item :"),n()(),r(10,"td",35)(11,"span",37),p(12),n()()(),r(13,"tr",34)(14,"td",35)(15,"div",36),p(16,"Total Item Qty:"),n()(),r(17,"td",35)(18,"span",37),p(19),n()()(),r(20,"tr",34)(21,"td",35)(22,"div",36),p(23,"Total Point Value"),n()(),r(24,"td",35)(25,"span",38),p(26),n()()()()()()),d&2){let e=c(2);s(2),l("columns",e.headerColumn)("tableHead","border-b")("showCheckbox",!1),s(),l("ngForOf",e.selectedItems),s(9),v(e.selectedItems.length),s(7),v(e.totalItemQuantity),s(7),v(e.totalPointValue)}}function pe(d,i){if(d&1&&(r(0,"div",19),f(1,"spk-input",45),n()),d&2){let e=c(2);s(),l("label",e.stockForm.value.purchase_from)("fieldReq",!0)}}function ue(d,i){if(d&1){let e=S();r(0,"div",8)(1,"form",9),g("ngSubmit",function(){u(e);let o=c();return h(o.onSubmit())}),r(2,"div",3)(3,"div",4)(4,"div",10)(5,"div",11)(6,"div",10)(7,"div",11)(8,"spk-ng-select",12),g("selectedChange",function(o){u(e);let a=c();return a.getReceiverCustomer(o),a.product=[],a.getProduct(),h(a.findName(o,"customer_type_id"))}),n()(),r(9,"div",11)(10,"spk-ng-select",13),g("searchChanged",function(o){u(e);let a=c();return h(a.onSearch(o,"customer"))})("selectedChange",function(o){u(e);let a=c();return h(a.findName(o,"customer_id"))}),n()(),r(11,"div",11)(12,"spk-ng-select",14),g("searchChanged",function(o){u(e);let a=c();return h(a.onSearch(o,"product"))}),n()(),r(13,"div",11)(14,"div",15),f(15,"spk-input",16),r(16,"button",17),g("click",function(){u(e);let o=c();return h(o.addToList())}),f(17,"i",18),n()()(),b(18,me,27,7,"div",2),n()(),r(19,"div",11)(20,"div",10)(21,"div",19),f(22,"spk-flatpickr",20),n(),r(23,"div",19),f(24,"spk-input",21),n(),r(25,"div",19),f(26,"spk-input",22),n(),r(27,"div",11)(28,"spk-ng-select",23),g("searchChanged",function(o){u(e);let a=c();return h(a.onSearch(o,"product"))}),n()(),b(29,pe,2,2,"div",24),r(30,"div",19),f(31,"spk-input",25),n(),r(32,"div",19)(33,"label",26),p(34,"Upload Bill Copy "),n(),r(35,"file-pond",27),g("onremovefile",function(o){u(e);let a=c();return h(a.onFileRemove(o,"image"))})("onprocessfile",function(o){u(e);let a=c();return h(a.onFileProcessed(o,"image"))}),n()()()()(),r(36,"div",28),f(37,"app-button",29),n()()()()()}if(d&2){let e=c();s(),l("formGroup",e.stockForm),s(7),l("fieldReq",!0)("options",e.customerCategorySubType)("multiple",!1),s(2),l("fieldReq",!0)("search",!0)("options",e.customerData)("multiple",!1),s(2),l("search",!0)("fieldReq",e.selectedItems.length===0)("options",e.product)("multiple",!1),s(3),l("fieldReq",e.selectedItems.length===0),s(3),l("ngIf",e.selectedItems.length>0),s(4),l("fieldReq",!0)("max",e.today),s(2),l("fieldReq",!0),s(2),l("fieldReq",!0),s(2),l("search",!1)("fieldReq",!0)("options",e.customerType)("multiple",!1),s(),l("ngIf",e.stockForm.value.purchase_from!="Factory"&&e.stockForm.value.purchase_from),s(2),l("fieldReq",!1),s(4),l("options",e.getPondOptions("image"))("files",e.pondImages),s(2),l("buttonType","submit")("buttonClass","ti-btn ti-btn-primary m-0")("iconClass",e.api.disabled?"ri-loader-2-fill animate-spin":"ri-save-line")("loadingIconClass","ri-loader-2-fill")("disabled",e.api.disabled)}}var re=class d{constructor(i,e,t,o,a,k,he,fe,_e){this.toastr=i;this.api=e;this.formValidation=t;this.fb=o;this.router=a;this.route=k;this.commonApi=he;this.uploadService=fe;this.moduleService=_e}skLoading=!1;stockForm;today=new Date;pondFiles=[];submodule;pondPdf=[];pondImages=[];pondOptions=this.getPondOptions("image");pondDocumentOptions=this.getPondOptions("pdf");product=[];customerType=[{label:"Distributor",value:"Distributor"},{label:"Dealer",value:"Dealer"},{label:"Branch",value:"Branch"},{label:"Factory",value:"Factory"}];accessRight={};selectedItems=[];detailData={};ngOnInit(){let i=this.router.getCurrentNavigation();if(i?.extras?.state?.detail)this.detailData=i.extras.state.detail;else{let o=history.state;o?.detail&&(this.detailData=o.detail)}let e=this.moduleService.getSubModuleByName("IRP","Purchase");e&&(this.submodule=e);let t=this.moduleService.getAccessMap("Purchase");console.log(t,"accessRight"),t&&(this.accessRight=t),this.stockForm=this.fb.group({bill_date:["",m.required],bill_amount:["",m.required],bill_number:["",m.required],login_type_id:[""],customer_type_id:[{value:"",disabled:!1},m.required],customer_id:[{value:"",disabled:!1},m.required],purchase_from:[{value:"",disabled:!1},m.required],purchase_from_name:[{value:"",disabled:!1},m.required],product_id:["",m.required],customer_name:[""],customer_type_name:[""],remark:[""],qty:["",m.required],selectedItems:[""]}),this.stockForm.get("purchase_from")?.valueChanges.subscribe(o=>{let a=this.stockForm.get("purchase_from_name");o!="Factory"?a?.setValidators([m.required]):(this.stockForm.removeControl("purchase_from_name"),a?.clearValidators()),a?.updateValueAndValidity()}),this.detailData&&Object.keys(this.detailData).length>0?this.detailData.pageFrom==="Detail Page"&&(this.stockForm.patchValue({customer_type_id:this.detailData.customer_type_id}),this.stockForm.get("customer_type_id")?.disable(),this.stockForm.patchValue({login_type_id:this.detailData.login_type_id}),this.getReceiverCustomer(this.detailData.login_type_id),this.stockForm.patchValue({customer_id:this.detailData._id}),this.stockForm.get("customer_id")?.disable(),this.stockForm.patchValue({customer_name:this.detailData.customer_name}),this.stockForm.patchValue({customer_type_name:this.detailData.customer_type_name}),this.commonApi.getCustomerCategorySubType([y.PRIMARY]),this.getCustomerCategorySubType([y.INFLUENCER,y.SECONDARY]),this.getProduct()):(this.commonApi.getCustomerCategorySubType([y.PRIMARY,y.SECONDARY]),this.getCustomerCategorySubType([y.INFLUENCER,y.SECONDARY]))}getPondOptions(i){let e={allowFileTypeValidation:!0,allowFileSizeValidation:!0,labelIdle:"Click or drag files here to upload...",server:{process:(t,o,a,k)=>{setTimeout(()=>{k(Date.now().toString())},1e3)},revert:(t,o)=>{o()}}};return i==="image"?x(C({},e),{allowMultiple:!0,acceptedFileTypes:["image/jpeg","image/png","image/jpg","application/pdf"],maxFiles:2,allowImageValidateSize:!0,labelFileTypeNotAllowed:"Only PNG, JPEG, or PDF files are allowed",fileValidateTypeLabelExpectedTypes:"Allowed: PNG, JPEG, PDF",labelImageValidateSizeTooSmall:"Image is too small. Min: {minWidth}\xD7{minHeight}",labelImageValidateSizeTooBig:"Image is too large. Max: {maxWidth}\xD7{maxHeight}",fileValidateFunction:t=>{let o=t.type==="application/pdf",a=o?1*1024*1024:2*1024*1024;return t.size>a?Promise.reject(`Max size exceeded: ${o?"10MB for PDF":"2MB for images"}`):Promise.resolve()}}):x(C({},e),{allowMultiple:!1,maxFiles:2,acceptedFileTypes:["application/pdf"],maxFileSize:"10MB",labelFileTypeNotAllowed:"Only PDF files are allowed",fileValidateTypeLabelExpectedTypes:"Allowed: PDF"})}onFileProcessed(i,e){let t=i.file.file;Object.assign(t,{image_type:e}),e==="image"?this.pondImages=[...this.pondImages||[],t]:e==="pdf"&&(this.pondPdf=[...this.pondPdf||[],t])}onFileRemove(i,e){let t=i.file.file;if(e==="image"){let o=this.pondImages.findIndex(a=>a.name===t.name&&a.size===t.size);o>-1&&this.pondImages.splice(o,1)}else if(e==="pdf"){let o=this.pondPdf.findIndex(a=>a.name===t.name&&a.size===t.size);o>-1&&this.pondPdf.splice(o,1)}}customerLoginType=[];customerLoginType$=new I;getCustomerLoginType(i){this.api.post({login_type_ids:i},"rbac/read-login-types").subscribe(e=>{e.statusCode===200&&(this.customerLoginType=e.data,this.customerLoginType$.next(e.data))})}customerCategorySubType=[];getCustomerCategorySubType(i,e){this.api.post({login_type_id:i,search:e},"rbac/read-customer-type").subscribe(t=>{t.statusCode===200&&(this.customerCategorySubType=t.data)})}getReceiverCustomer(i){let e=this.customerCategorySubType.find(t=>t.value===i);e&&(this.stockForm.patchValue({login_type_name:e.label}),this.stockForm.patchValue({login_type_id:e.login_type_id})),this.getCustomerData(this.stockForm.value.customer_type_id,this.stockForm.value.login_type_id)}customerData=[];getCustomerData(i,e,t){this.api.post({customer_type_id:i,login_type_id:e,search:t},"customer/read-dropdown").subscribe(o=>{o.statusCode===200&&(this.customerData=o.data)})}lastSearchTerm="";onSearch(i,e){let t=i?.trim()||"";t!==this.lastSearchTerm&&(this.lastSearchTerm=t,e==="customer"&&this.getCustomerData(this.stockForm.value.customer_type_id,this.stockForm.value.login_type_id,i),e==="product"&&this.getProduct(i))}getProduct(i){this.api.post({"dropdown-name":"Product",customer_type_id:this.detailData?.customer_type_id?this.detailData?.customer_type_id:this.stockForm.value.customer_type_id,filters:{search:i}},"product/read-dropdown").subscribe(e=>{e.statusCode==200&&(this.product=e.data)})}totalItemQuantity=0;totalPointValue=0;addToList(){let i=this.stockForm.get("product_id")?.value,e=this.stockForm.get("qty")?.value;if(this.selectedItems.length===0){if(!i){this.toastr.error("Please select a product.","","toast-top-right");return}if(e<=0){this.toastr.error("Please enter a valid quantity greater than 0.","","toast-top-right");return}}let t=this.product.find(a=>a.value===i);if(!t){this.toastr.error("Selected product not found.","","toast-top-right");return}let o=this.selectedItems.find(a=>a.value===i);o?o.qty+=e:this.selectedItems.push({label:t.label,value:t.value,product_code:t.product_code,point_value:t.point_value,qty:e}),this.stockForm.get("product_id")?.reset(),this.stockForm.get("qty")?.reset(),this.selectedItems.length>0&&(this.stockForm.get("product_id")?.clearValidators(),this.stockForm.removeControl("product_id"),this.stockForm.removeControl("qty"),this.stockForm.get("qty")?.clearValidators(),this.stockForm.get("product_id")?.updateValueAndValidity(),this.stockForm.get("qty")?.updateValueAndValidity()),this.summary()}summary(){this.totalItemQuantity=0,this.totalPointValue=0,this.selectedItems.forEach(i=>{let e=Number(i.qty)||0,t=Number(i.point_value)||0;this.totalItemQuantity+=e,this.totalPointValue+=e*t})}headerColumn=[{label:"S.No",table_class:"text-center"},{label:"Product Name",table_class:""},{label:"QTY",table_class:"text-center"},{label:"Point Per Qty.",table_class:"text-right"},{label:"Action",table_class:"text-center"}];delete(i){this.selectedItems.splice(i,1),this.toastr.success("Produc removed from the list.","","toast-top-right"),this.summary(),this.selectedItems.length===0&&(this.stockForm.get("product_id")?.setValidators(m.required),this.stockForm.get("qty")?.setValidators([m.required,m.min(1)]))}findName(i,e){if(e==="customer_type_id"){let t=this.customerCategorySubType.findIndex(o=>o.value===i);t!==-1&&this.stockForm.patchValue({customer_type_name:this.customerCategorySubType[t].label})}if(e==="customer_id"){let t=this.customerData.findIndex(o=>o.value===i);t!==-1&&this.stockForm.patchValue({customer_name:this.customerData[t].label})}}onSubmit(){this.stockForm.valid?(this.api.disabled=!0,this.stockForm.patchValue({selectedItems:this.selectedItems}),this.pondFiles=[...this.pondImages,...this.pondPdf],this.api.post(this.stockForm.getRawValue(),"purchase/create").subscribe(i=>{i.statusCode==200&&(this.pondFiles.length>0?(this.uploadService.uploadFile(i.data.inserted_id,"purchase",this.pondFiles,"Purchase Bill",this.submodule,"/apps/loyalty/purchase"),this.api.disabled=!1):(this.api.disabled=!1,this.router.navigate(["/apps/loyalty/purchase"]),this.toastr.success(i.message,"","toast-top-right")))})):this.formValidation.markFormGroupTouched(this.stockForm)}static \u0275fac=function(e){return new(e||d)(_(D),_(G),_(X),_(j),_(q),_(R),_(z),_(ie),_(Y))};static \u0275cmp=P({type:d,selectors:[["app-purchase-add"]],decls:3,vars:7,consts:[[3,"title","title1","activeitem","btnShow1"],["class","box",4,"ngIf"],["class","xl:col-span-12 col-span-12",4,"ngIf"],[1,"box"],[1,"p-4"],[1,"grid","grid-cols-12","gap-x-6"],["class","xl:col-span-3 col-span-12 ",4,"ngFor","ngForOf"],[1,"xl:col-span-3","col-span-12"],[1,"xl:col-span-12","col-span-12"],[3,"ngSubmit","formGroup"],[1,"grid","grid-cols-12","sm:gap-x-4","sm:gap-y-4"],[1,"xxl:col-span-6","xl:col-span-6","lg:col-span-6","md:col-span-6","col-span-12"],["formControlName","customer_type_id","label","Influencer Category",3,"selectedChange","fieldReq","options","multiple"],["formControlName","customer_id","label","Influencer",3,"searchChanged","selectedChange","fieldReq","search","options","multiple"],["formControlName","product_id","label","Select Product",3,"searchChanged","search","fieldReq","options","multiple"],[1,"flex","gap-2","justify-center","items-end"],["label","QTY","formControlName","qty","type","number",1,"remove-default-class","wp100",3,"fieldReq"],["type","button","aria-label","button",1,"ti-btn","m-0","ti-btn-icon","ti-btn-primary","btn-wave",3,"click"],[1,"ri-add-line"],[1,"xxl:col-span-6","xl:col-span-6","lg:col-span-6","md:col-span-6"],["placeholder","Bill Date","label","Bill Date","formControlName","bill_date",1,"form-control","custom-datepickr",3,"fieldReq","max"],["label","Bill Number","formControlName","bill_number","type","text",1,"remove-default-class",3,"fieldReq"],["label","Bill Amount Without GST","formControlName","bill_amount","type","number",1,"remove-default-class",3,"fieldReq"],["formControlName","purchase_from","label","Purchase From",3,"searchChanged","search","fieldReq","options","multiple"],["class","xxl:col-span-6 xl:col-span-6 lg:col-span-6 md:col-span-6",4,"ngIf"],["label","Remark","formControlName","remark","type","textarea",1,"remove-default-class",3,"fieldReq"],[1,"form-label","mb-0"],[1,"filepond","basic-filepond",3,"onremovefile","onprocessfile","options","files"],[1,"flex","items-center","justify-end","mt-10","gap-2"],[3,"buttonType","buttonClass","iconClass","loadingIconClass","disabled"],[1,"table-responsive","mt-4","table-bordered-default"],["tableClass","ti-custom-table ti-custom-table-hover ti-head-primary",3,"columns","tableHead","showCheckbox"],[4,"ngFor","ngForOf"],[1,"ti-custom-table","text-nowrap"],[1,"border-b","!border-defaultborder","dark:!border-defaultborder/10"],[1,"text-right"],[1,"font-semibold"],[1,"font-medium"],[1,"text-right","font-medium"],[1,"w60","text-center"],[1,"w50","text-center"],[1,"w120","text-right"],[1,"w60","relative"],[1,"flex","flex-row","items-center","!gap-2","text-[0.9375rem]"],[3,"clickEvent","icon","buttonClass"],["formControlName","purchase_from_name","type","text",1,"remove-default-class",3,"label","fieldReq"]],template:function(e,t){e&1&&(f(0,"app-page-header",0),b(1,de,4,2,"div",1)(2,ue,38,31,"div",2)),e&2&&(l("title","IRP")("title1",F(6,se))("activeitem","Purchase Add")("btnShow1",!1),s(),l("ngIf",t.skLoading),s(),l("ngIf",!t.skLoading))},dependencies:[W,te,V,T,M,E,N,O,B,Z,oe,Q,ee,ae,U,w,L,A,K,J,$,H],encapsulation:2})};export{re as PurchaseAddComponent};
