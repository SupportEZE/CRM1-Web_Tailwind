import{a as ye}from"./chunk-GXF7AAOQ.js";import{a as ue}from"./chunk-PU6S26UW.js";import{a as _e}from"./chunk-ZON5AR26.js";import"./chunk-LGZVJJDX.js";import{a as he}from"./chunk-54KZ5YIV.js";import"./chunk-SQZ3YN6N.js";import"./chunk-CIBZCVJQ.js";import{a as pe}from"./chunk-OTFCGVEU.js";import{a as ce}from"./chunk-HPLI5COI.js";import"./chunk-DUVWFXSE.js";import"./chunk-OEHD5D2Y.js";import{a as fe}from"./chunk-GLWQGYBC.js";import{a as ee}from"./chunk-DC4QM32I.js";import{C as le,F as me,c as Z,f as ne,k as se,n as ae,v as de}from"./chunk-VHE3PQ3O.js";import{C as $,D as H,H as J,M as K,Qa as oe,V as X,W as q,X as Q,Y as W,Z as Y,ca as te,da as ie,hb as re,l as B,w as z}from"./chunk-GYDYF5F3.js";import{K as G,M as U,f as k,g as R,n as N,t as j}from"./chunk-PD5VTTIY.js";import{Aa as g,Ba as F,Hb as E,Ob as _,Xc as O,Yc as x,_b as l,cc as M,ed as w,fd as A,kc as u,lc as f,mc as I,nc as V,oc as P,qc as T,qd as L,rb as p,sb as d,wc as v,yc as m}from"./chunk-2NSPOFEK.js";import"./chunk-EU2KAMEK.js";import{a as S,i as D}from"./chunk-66YHNWRR.js";var Fe=()=>["Product"],ve=()=>[];function be(n,t){n&1&&(u(0,"div",8),I(1,"app-skeleton"),f())}function Ce(n,t){n&1&&(u(0,"div",4)(1,"div",5)(2,"div",6),_(3,be,2,0,"div",7),f()()()),n&2&&(p(3),l("ngForOf",x(1,ve).constructor(10)))}function Se(n,t){if(n&1){let e=T();u(0,"div")(1,"app-form-field",17,0),v("valueChange",function(r){g(e);let i=m().$implicit,a=m(4);return F(a.onFieldChange(r,i))})("searchChanged",function(r){g(e);let i=m().$implicit,a=m(4);return F(i.search?a.onSearch(r,i):"")}),f()()}if(n&2){let e=m().$implicit,o=m(4);M("mb-4 ",e.class_name,""),p(),l("field",e)("form",o.myForm)}}function Ie(n,t){if(n&1&&(V(0),_(1,Se,3,5,"div",16),P()),n&2){let e=t.$implicit;p(),l("ngIf",e.is_show===!0&&(e.is_parent_dependency===!1||e.is_child_show===!0))}}function Te(n,t){if(n&1&&(u(0,"div",6),_(1,Ie,2,1,"ng-container",15),f()),n&2){let e=m(3);p(),l("ngForOf",e.formFields)}}function xe(n,t){if(n&1){let e=T();u(0,"form",11),v("ngSubmit",function(){g(e);let r=m(2);return F(r.onSubmit())}),u(1,"div",4)(2,"div",5),_(3,Te,2,1,"div",12),f(),u(4,"div",13),I(5,"app-button",14),f()()()}if(n&2){let e=m(2);l("formGroup",e.myForm),p(3),l("ngIf",e.myForm&&e.myForm.controls),p(2),l("buttonType","submit")("buttonClass","ti-btn ti-btn-primary m-0")("disabled",e.api.disabled)("formType",e.pageType)("iconClass","ri-save-line")("loadingIconClass","ri-loader-2-fill")}}function De(n,t){if(n&1&&(u(0,"div",9),_(1,xe,6,8,"form",10),f()),n&2){let e=m();p(),l("ngIf",e.formIniatialized)}}var ge=class n{constructor(t,e,o,r,i,a,s,h,y,b,c,C,Ee){this.spaceRemove=t;this.cdr=e;this.fb=o;this.util=r;this.toastr=i;this.api=a;this.dialog=s;this.route=h;this.router=y;this.uploadService=b;this.logService=c;this.moduleService=C;this.formValidation=Ee}productId;pageType="add";formGroup=new H({});formFields=[];myForm;primaryForm;FORMID=ce;moduleFormId=0;submodule;skLoading=!1;fieldTypes=B;formIniatialized=!1;tagsElement;type="component";Math=Math;pondFiles=[];originalFormFields=[];ngOnInit(){let t=this.moduleService.getSubModuleByName("Masters","Products"),e=this.moduleService.getFormById("Masters","Products",this.FORMID.ID.Products);t&&(this.submodule=t),e&&(this.submodule.form_id=e.form_id,this.moduleFormId=e.form_id,this.getFormData()),this.route.paramMap.subscribe(o=>{if(o){this.productId=o.get("id");let r=o.get("edit");this.pageType=r||"add"}})}initializeForm(){this.myForm=this.fb.group({}),this.formFields.forEach(t=>{t.api_path&&this.getOptions(t.name,t.api_path),t.control=this.fb.control("",this.formValidation.getValidators(t)),this.myForm.addControl(t.name,t.control)}),this.formIniatialized=!0,this.productId&&this.getProductDetail()}onResetDependentFields(t){this.formFields[t].child_dependency.length!=0&&this.formFields[t].child_dependency.map(e=>{let o=this.formFields.findIndex(r=>r.name===e.child_field_name);o!==-1&&(this.myForm.controls[e.child_field_name].reset(),this.formFields[o].value=""),this.onResetDependentFields(o)})}onFieldChange(t,e){if(e.type==this.fieldTypes.SINGLE_SELECT||e.type==this.fieldTypes.MULTI_SELECT||e.type==this.fieldTypes.RADIO_SELECT||e.type==this.fieldTypes.CHECKBOX_SELECT||e.type==this.fieldTypes.DATE||e.type==this.fieldTypes.TIME||e.type==this.fieldTypes.UPLOAD)if(e.type==this.fieldTypes.SINGLE_SELECT){if(e.control.setValue(t),e.value=t.label,e.key_name_required===!0){let o=e.options.findIndex(i=>i.value===t),r;o!==-1&&(r=e.options[o].label,this.formFields.forEach(i=>{i.name===e.key_name&&this.myForm.controls[i.name].setValue(r)}))}}else e.control.setValue(t);if(e.type===this.fieldTypes.DATE_RANGE){let o={from:t.from,to:t.to};this.myForm.controls[e.name].setValue(o)}if(e.type===this.fieldTypes.UPLOAD&&(this.pondFiles=t),e.is_child_dependency===!0){let o=e.options.findIndex(r=>r.value===t);o!==-1&&(e.type===this.fieldTypes.SINGLE_SELECT&&e.key_source==="default"?(e.value=e.options[o].value,this.getDependencyUpdate(e)):(e.value=e.options[o].label,this.getDependencyUpdate(e)))}if(e.is_child_dependency){let o=this.formFields.findIndex(r=>r.name==e.name);this.onResetDependentFields(o);for(let r=o;r<=this.formFields.length-1;r++){let a=this.formFields[r].options?.find(s=>this.spaceRemove.formatString(s.value)===this.spaceRemove.formatString(this.formFields[r].value))?.label||"";for(let s=0;s<=this.formFields[r].child_dependency.length-1;s++){let h=!1,y=this.formFields[r].child_dependency[s];if(y.visibilty==="Direct"&&(y.parent_field_value===a||y.child_field_option.length===0&&this.formFields[r].is_child_show)&&(h=!0),this.formFields[r].child_dependency[s].visibilty==="Option"){let c=this.formFields.findIndex(C=>C.name==this.formFields[r].child_dependency[s].child_field_name);if(c!==-1&&this.formFields[c].type===this.fieldTypes.SHORT_TEXT&&this.formFields[r].value&&(h=!0,this.formFields[c].is_child_show=h),c!==-1&&this.formFields[c].type===(this.fieldTypes.SINGLE_SELECT||this.fieldTypes.MULTI_SELECT)){let C=this.getOptions(this.formFields[c].name,this.formFields[c].api_path,e.value)}}let b=this.formFields.findIndex(c=>c.name==this.formFields[r].child_dependency[s].child_field_name);b!==-1&&(this.formFields[b].is_child_show=h)}}}}onClick(t){}getFormData(){this.skLoading=!0,this.api.post({form_id:this.moduleFormId,platform:"web"},"form-builder/read").subscribe(t=>{t.statusCode==200&&(t?.data?.form_data&&(this.originalFormFields=JSON.parse(JSON.stringify(t.data.form_data))),this.formFields=t.data.form_data,this.skLoading=!1,this.formFields.forEach(e=>{this.util.createValidation(e)}),this.initializeForm())})}lastSearchTerm="";onSearch(t,e){let o=t?.trim()||"";o!==this.lastSearchTerm&&(this.lastSearchTerm=o,this.api.post({module_id:this.submodule.sub_module_id||this.submodule.module_id,page:1,dropdown_name:e.name,filters:{search:o}},e.api_path).subscribe({next:r=>{r.statusCode===200&&(e.options=r.data)}}))}originalData={};getProductDetail(){this.api.post({_id:this.productId},"product/detail").subscribe(t=>{if(t.statusCode===200){let e;e=t.data,this.originalData=S(S({},e),e.form_data),delete this.originalData.form_data;let o=Object.keys(this.originalData),r=this.formFields.filter(i=>o.includes(i.name)&&(i.type===this.fieldTypes.SINGLE_SELECT||i.type===this.fieldTypes.MULTI_SELECT));if(this.myForm.patchValue(this.originalData),r.length>0)for(let i=0;i<r.length;i++){let a=r[i].name;this.myForm.controls[a]&&this.myForm.controls[a].setValue(this.originalData[a]);for(let s=0;s<this.formFields.length;s++)this.formFields[s].name===a&&this.originalData[a]&&(this.formFields[s].is_child_show=!0,this.formFields[s].value=this.originalData[a],this.getDependencyUpdate(this.formFields[s]))}}})}getOptions(t,e,o){return D(this,null,function*(){try{let r=yield this.api.post({dropdown_name:t,module_id:this.submodule.sub_module_id||this.submodule.module_id,dropdown_option:o},e).toPromise();r?.statusCode===200&&(this.formFields.forEach(i=>{i.name===t&&(i.options=r.data,o&&r.data.length>0&&(i.is_child_show=!0))}),this.originalFormFields.forEach(i=>{i.name===t&&(i.options=r.data)}))}catch(r){console.error("Error fetching options:",r)}})}getDependencyUpdate(t){if(t.is_child_dependency){let e,o,r;if(t.key_source==="default"){let i=t.options.find(a=>a.value===t.value);e=i?i.label:null}t.child_dependency.forEach(i=>{let a=this.formFields.find(s=>s.name===i.child_field_name);if(a){o=a.name;let s=i.child_field_option.find(h=>h.parent_field_value===e);r=s?s.label:null}})}}cleanDetailObject(){if(!this.originalData||!this.myForm.value)return;let t=this.myForm.value;this.originalData=Object.keys(this.originalData).filter(e=>e in t).reduce((e,o)=>(e[o]=this.originalData[o],e),{})}onSubmit(){if(this.formFields.forEach(t=>{(t.is_child_show===!1||t.is_show===!1)&&(this.myForm.get(t.name)?.clearValidators(),this.myForm.get(t.name)?.updateValueAndValidity())}),this.myForm.valid){this.api.disabled=!0;let t={primaryFields:{form_data:{}}};this.formFields.forEach(i=>{i.name&&this.myForm.value.hasOwnProperty(i.name)&&(i.read_only===!1&&i.key_source!=="custom"&&(t.primaryFields[i.name]=this.myForm.value[i.name]),i.key_source==="custom"&&(t.primaryFields.form_data[i.name]=this.myForm.value[i.name]),i.type===this.fieldTypes.UPLOAD&&delete t.primaryFields.form_data[i.name])}),t.primaryFields.form_data.files=this.myForm.value.files;let e=this.pageType==="edit";if(e&&(t.primaryFields._id=this.productId,this.logService.logActivityOnUpdate(e,this.originalData,this.myForm.value,this.submodule.sub_module_id?this.submodule.sub_module_id:this.submodule.module_id,this.submodule.title,"update",this.originalData._id||null,()=>{},this.submodule.module_type)&&this.pondFiles.length===0)){this.api.disabled=!1,this.toastr.warning("No changes detected","","toast-top-right");return}let o=e?"patch":"post",r=e?"product/update":"product/create";this.api[o](t.primaryFields,r).subscribe(i=>{i.statusCode===200&&(this.pondFiles.length>0?this.uploadService.uploadFile(i.data.inserted_id,"product",this.pondFiles,"Product Images",this.submodule,"/apps/master/products-list",()=>{},void 0,this.originalData.files):(this.api.disabled=!1,this.router.navigate(["/apps/master/products-list"]),this.toastr.success(i.message,"","toast-top-right")))})}else{this.toastr.error("Form Is Invalid","","toast-top-right"),this.formValidation.markFormGroupTouched(this.myForm);let t=Object.keys(this.myForm.controls).filter(e=>this.myForm.get(e)?.invalid);console.warn("Invalid fields:",t)}}openModal(t){this.dialog.open(_e,{data:{lastPage:"product",form_Fields:this.originalFormFields,moduleFormId:this.moduleFormId,moduleId:this.submodule.sub_module_id,moduleName:this.submodule.title,moduleData:this.submodule}}).afterClosed().subscribe(o=>{o===!0&&this.getFormData()})}checkDuplicate(t,e){this.api.post({product_code:e},t).subscribe(o=>{o===!1?this.api.isDuplicate=!0:this.api.isDuplicate=!1})}static \u0275fac=function(e){return new(e||n)(d(he),d(L),d(X),d(W),d(z),d(Y),d(oe),d(G),d(U),d(ue),d(pe),d(ee),d(de))};static \u0275cmp=E({type:n,selectors:[["app-add-product"]],inputs:{formFields:"formFields"},features:[O([te])],decls:4,vars:16,consts:[["dynamicForm",""],[3,"buttonClick","buttonClick1","title","title1","activeitem","buttonText","icon","btnShow","buttonValue","buttonText1","icon1","btnShow1","buttonValue1"],["class","box",4,"ngIf"],["class","xl:col-span-12 col-span-12",4,"ngIf"],[1,"box"],[1,"p-4"],[1,"grid","grid-cols-12","gap-x-6"],["class","xl:col-span-3 col-span-12 mb-4",4,"ngFor","ngForOf"],[1,"xl:col-span-3","col-span-12","mb-4"],[1,"xl:col-span-12","col-span-12"],[3,"formGroup","ngSubmit",4,"ngIf"],[3,"ngSubmit","formGroup"],["class","grid grid-cols-12 gap-x-6",4,"ngIf"],[1,"box-footer","border-t","border-block-start-dashed","sm:flex","justify-end"],[3,"buttonType","buttonClass","disabled","formType","iconClass","loadingIconClass"],[4,"ngFor","ngForOf"],[3,"class",4,"ngIf"],[3,"valueChange","searchChanged","field","form"]],template:function(e,o){e&1&&(u(0,"app-page-header",1),w(1,"titlecase"),v("buttonClick",function(i){return o.onClick(i)})("buttonClick1",function(i){return o.openModal(i)}),f(),_(2,Ce,4,2,"div",2)(3,De,2,1,"div",3)),e&2&&(l("title","Master Modules")("title1",x(15,Fe))("activeitem",A(1,13,o.pageType)+" Product")("buttonText","Filter")("icon","filter_list")("btnShow",!1)("buttonValue","filter_data")("buttonText1","Form Config")("icon1","settings")("btnShow1",!0)("buttonValue1",""),p(2),l("ngIf",o.skLoading),p(),l("ngIf",!o.skLoading))},dependencies:[me,k,R,J,$,K,fe,ye,Z,le,N,ie,ne,se,q,ae,Q,re,j],encapsulation:2})};export{ge as AddProductComponent};
