import{a as Me}from"./chunk-SQZ3YN6N.js";import{c as Fe}from"./chunk-CIBZCVJQ.js";import{a as be}from"./chunk-OEHD5D2Y.js";import{a as se}from"./chunk-DC4QM32I.js";import{C as Se,F as Ie,g as he,r as Ce,v as xe,w as ye}from"./chunk-VHE3PQ3O.js";import{A as F,B as K,C as X,E as Z,G as $,Ga as me,H as ee,M as te,Oa as pe,P as ie,Pa as ue,R as oe,Ta as _e,Ua as ve,V as ne,W as ae,X as re,Ya as fe,Z as le,hb as ge,oa as ce,p as Q,w as z,wa as de,z as J}from"./chunk-GYDYF5F3.js";import{K as W,M as H,f as L,g as U,r as G,t as Y}from"./chunk-PD5VTTIY.js";import{Aa as g,Ba as b,Hb as j,Lc as S,Mc as _,Nc as M,Ob as v,Oc as E,Pc as q,Uc as R,Vc as A,Wc as D,_b as s,ed as N,gd as P,kc as r,lc as l,mc as C,nc as T,oc as w,qc as I,rb as a,sb as f,wc as y,yc as m}from"./chunk-2NSPOFEK.js";import{a as B,b as O}from"./chunk-66YHNWRR.js";function ke(n,o){if(n&1&&(r(0,"mat-option",18),_(1),l()),n&2){let e=o.$implicit;s("value",e.name),a(),M(e.name)}}function Te(n,o){n&1&&(T(0),_(1,"This field is required"),w())}function we(n,o){if(n&1&&(r(0,"div",19),v(1,Te,2,0,"ng-container",20),l()),n&2){m();let e=S(12);a(),s("ngIf",e.errors==null?null:e.errors.required)}}function Ee(n,o){n&1&&(T(0),_(1,"This field is required"),w())}function qe(n,o){if(n&1&&(r(0,"div",19),v(1,Ee,2,0,"ng-container",20),l()),n&2){m();let e=S(7);a(),s("ngIf",e.errors==null?null:e.errors.required)}}function Re(n,o){if(n&1){let e=I();r(0,"div",21)(1,"label",9),_(2,"Reason"),r(3,"span",10),_(4,"*"),l()(),r(5,"mat-form-field",22)(6,"textarea",23,2),D("ngModelChange",function(t){g(e);let d=m(2);return A(d.data.reason,t)||(d.data.reason=t),b(t)}),l()(),v(8,qe,2,1,"div",14),l()}if(n&2){let e=S(7);m();let i=S(3),t=m();a(6),R("ngModel",t.data.reason),a(2),s("ngIf",e.touched||i.submitted)}}function Ae(n,o){if(n&1){let e=I();r(0,"div",4)(1,"app-modal-header",5),y("close",function(){g(e);let t=m();return b(t.closeModal())}),l(),r(2,"form",6,0),y("ngSubmit",function(){g(e);let t=S(3),d=m();return b(t.valid&&d.statusChange())}),r(4,"mat-dialog-content",7)(5,"div",8)(6,"label",9),_(7),r(8,"span",10),_(9,"*"),l()(),r(10,"mat-form-field",11)(11,"mat-select",12,1),D("ngModelChange",function(t){g(e);let d=m();return A(d.data.status,t)||(d.data.status=t),b(t)}),v(13,ke,2,2,"mat-option",13),l()(),v(14,we,2,1,"div",14),l(),v(15,Re,9,2,"div",15),l(),r(16,"mat-dialog-actions",16),C(17,"app-button",17),l()()()}if(n&2){let e=S(3),i=S(12),t=m();a(),s("title","Change Status")("closeBtn",!0),a(6),E("Status ",t.data.status,""),a(4),R("ngModel",t.data.status),a(2),s("ngForOf",t.modalData.options),a(),s("ngIf",i.touched||e.submitted),a(),s("ngIf",t.data.status=="Cancel"),a(2),s("buttonType","submit")("buttonClass","ti-btn ti-btn-primary m-0")("disabled",t.api.disabled)("formType",t.modalData.formType)("iconClass","ri-save-line")("loadingIconClass","ri-loader-2-fill")}}function De(n,o){n&1&&(r(0,"div",31),C(1,"spk-input",40),l()),n&2&&(a(),s("fieldReq",!0))}function Ne(n,o){n&1&&(r(0,"div",41),C(1,"spk-input",42),l()),n&2&&(a(),s("fieldReq",!0))}function Pe(n,o){n&1&&(r(0,"div",41),C(1,"spk-input",43),l()),n&2&&(a(),s("fieldReq",!0))}function Be(n,o){n&1&&(r(0,"div",41),C(1,"spk-input",44),l()),n&2&&(a(),s("fieldReq",!0))}function Oe(n,o){if(n&1){let e=I();r(0,"tr")(1,"td",48),_(2),l(),r(3,"td"),_(4),l(),r(5,"td",49),_(6),l(),r(7,"td",49),_(8),N(9,"number"),l(),r(10,"td",49),_(11),l(),r(12,"td",49),_(13),N(14,"number"),l(),r(15,"td",50)(16,"div",51)(17,"app-icon-button",52),y("clickEvent",function(){let t=g(e).index,d=m(4);return b(d.delete(t))}),l()()()()}if(n&2){let e=o.$implicit,i=o.index,t=m(4);a(2),M(i+1),a(2),M(e.label||"---"),a(2),M(e.qty||0),a(2),q("",t.CURRENCY_SYMBOLS.RUPEE,"",P(9,10,e.mrp,"1.2-2"),""),a(3),E("",e.discount||0,"%"),a(2),q("",t.CURRENCY_SYMBOLS.RUPEE,"",P(14,13,e.net_price,"1.2-2"),""),a(4),s("icon","ri-delete-bin-line")("buttonClass","ti-btn btn-wave product-btn ti-btn-sm ti-btn-soft-danger waves-effect waves-light")}}function je(n,o){if(n&1&&(r(0,"div",45)(1,"spk-reusable-tables",46),v(2,Oe,18,16,"tr",47),l()()),n&2){let e=m(3);a(),s("columns",e.headerColumn)("tableHead","border-b")("showCheckbox",!1)("showS_No",!0)("showAction",!0),a(),s("ngForOf",e.selectedItems)}}function Le(n,o){if(n&1){let e=I();r(0,"div",28)(1,"div",29)(2,"div",30)(3,"div",31),C(4,"spk-ng-select",32),l(),v(5,De,2,1,"div",33),l(),r(6,"div",30)(7,"div",31)(8,"spk-ng-select",34),y("searchChanged",function(t){g(e);let d=m(2);return b(d.onSearch(t,"product"))}),l()(),v(9,Ne,2,1,"div",35)(10,Pe,2,1,"div",35)(11,Be,2,1,"div",35),r(12,"div",36)(13,"button",37),y("click",function(){g(e);let t=m(2);return b(t.addToList())}),C(14,"i",38),l()(),r(15,"div",29),v(16,je,3,6,"div",39),l()()()()}if(n&2){let e,i,t,d,p=m(2);a(4),s("options",p.payment_mode)("multiple",!1)("fieldReq",!0),a(),s("ngIf",((e=p.stockForm.get("payment_mode"))==null?null:e.value)==="UPI/Online"),a(3),s("search",!0)("fieldReq",!0)("options",p.product)("multiple",!1),a(),s("ngIf",(i=p.stockForm.get("product_id"))==null?null:i.value),a(),s("ngIf",(t=p.stockForm.get("price"))==null?null:t.value),a(),s("ngIf",(d=p.stockForm.get("total_discount"))==null?null:d.value),a(5),s("ngIf",p.selectedItems.length>0)}}function Ue(n,o){if(n&1){let e=I();r(0,"div",4)(1,"app-modal-header",5),y("close",function(){g(e);let t=m();return b(t.closeModal())}),l(),r(2,"form",24),y("ngSubmit",function(){g(e);let t=m();return b(t.onSubmit())}),r(3,"mat-dialog-content",25),v(4,Le,17,12,"div",26),l(),r(5,"mat-dialog-actions",27),C(6,"app-button",17),l()()()}if(n&2){let e=m();a(),s("title","Add Invoice")("closeBtn",!0),a(),s("formGroup",e.stockForm),a(2),s("ngIf",!e.skLoading),a(2),s("buttonType","submit")("buttonClass","ti-btn ti-btn-primary m-0")("disabled",e.api.disabled)("formType",e.pageType)("iconClass","ri-save-line")("loadingIconClass","ri-loader-2-fill")}}var Ve=class n{constructor(o,e,i,t,d,p,V,x,c,u){this.modalData=o;this.api=e;this.moduleService=i;this.fb=t;this.comanFuncation=d;this.dialogRef=p;this.toastr=V;this.formValidation=x;this.router=c;this.route=u;console.log("Received Data:",this.modalData),this.data.status=o.status,this.data.reason=o.reason}CURRENCY_SYMBOLS=Q;pageType="add";skLoading=!1;data={};skloader=!1;stockForm;product=[];selectedItems=[];today=new Date;complaintId;serviceEngineerId;billingFromAddress;billingFromMobile;billingFromCustomer;submodule;payment_mode=[{label:"UPI/Online",value:"UPI/Online"},{label:"Cash",value:"Cash"}];headerColumn=[{label:"Product Name"},{label:"Qty",table_class:"text-right"},{label:"Mrp",table_class:"text-right"},{label:"Total Discount",table_class:"text-right"},{label:"Net Amount",table_class:"text-right"}];ngOnInit(){let o=this.moduleService.getSubModuleByName("WCMS","Invoice");o&&(this.submodule=o),this.stockForm=this.fb.group({product_id:[""],qty:[""],price:["",F.required],total_discount:[""],complaint_id:[""],payment_mode:[""],service_type:["Complaint",F.required],transaction_number:[""],net_amount:[0],total_items:[0],total_qty:[0],item:this.fb.array([])}),this.modalData?.complaint_id&&this.stockForm.patchValue({complaint_id:this.modalData.complaint_id}),this.stockForm.get("product_id")?.valueChanges.subscribe(e=>{let i=this.product.find(t=>t.value===e);i?this.stockForm.get("price")?.setValue(i.mrp||0):this.stockForm.get("price")?.setValue(0)}),this.stockForm.get("status")?.valueChanges.subscribe(e=>{this.toggleTransactionFields(e)}),this.getProduct()}get itemArray(){return this.stockForm.get("item")}toggleTransactionFields(o){let e=this.stockForm.get("transaction_number"),i=this.stockForm.get("cash");o==="Transaction Number"?(e?.setValidators([F.required]),i?.clearValidators(),i?.setValue("")):o==="Cash"?(i?.setValidators([F.required]),e?.clearValidators(),e?.setValue("")):(e?.clearValidators(),e?.setValue(""),i?.clearValidators(),i?.setValue("")),e?.updateValueAndValidity(),i?.updateValueAndValidity()}statusChange(){this.skloader=!0,this.comanFuncation.statusChange(this.data.status,this.modalData.DetailId,this.modalData.status,this.modalData.subModule,"without-toggle",this.modalData.apiPath,this.data.reason,this.modalData.reason).subscribe(o=>{this.skloader=!1,o&&this.dialogRef.close(!0)})}getProduct(o){this.api.post({_id:this.modalData.service_engineer_id,filters:{search:o}},"spare-part/read-dropdown").subscribe(e=>{e.statusCode==200&&(this.product=e.data)})}onSearch(o,e){e==="product"&&this.getProduct(o)}closeModal(){this.dialogRef.close()}addToList(){let o=this.stockForm.get("product_id")?.value,e=+this.stockForm.get("qty")?.value,i=+this.stockForm.get("total_discount")?.value||0,t=+this.stockForm.get("price")?.value||0;if(!o){this.toastr.error("Please select a product.","",{positionClass:"toast-top-right"});return}if(!e||e<=0){this.toastr.error("Please enter a valid quantity greater than 0.","",{positionClass:"toast-top-right"});return}let d=this.product.find(h=>h.value===o);if(!d){this.toastr.error("Selected product not found.","",{positionClass:"toast-top-right"});return}let p=e*t,V=p*i/100,x=p-V,c=this.selectedItems.find(h=>h.value===o),u=this.stockForm.get("item");if(c){c.qty+=e,c.discount=i,c.sub_total=c.qty*c.mrp,c.net_price=c.sub_total-c.sub_total*i/100;let h=this.selectedItems.findIndex(k=>k.value===o);u.at(h)&&u.at(h).patchValue({qty:c.qty,discount:i})}else this.selectedItems.push({label:d.label,value:d.value,product_code:d.product_code,qty:e,mrp:t,discount:i,sub_total:p,net_price:x,total_price:x}),u.push(this.fb.group({product_id:[o],qty:[e],discount:[i]}));this.stockForm.patchValue({product_id:"",qty:"",price:"",total_discount:""}),this.stockForm.markAsPristine(),this.stockForm.markAsUntouched(),this.stockForm.updateValueAndValidity()}setProductFieldValidators(o){["product_id","price","qty","total_disocunt"].forEach(i=>{let t=this.stockForm.get(i);t&&(t.clearValidators(),o&&t.setValidators([F.required]),t.updateValueAndValidity())})}onSubmit(){if(["product_id","qty","price","total_discount"].forEach(e=>{let i=this.stockForm.get(e);i&&(i.clearValidators(),i.updateValueAndValidity())}),this.stockForm.valid){let e=this.selectedItems.map(c=>{let u=c.qty*c.mrp,h=c.discount||0,k=u-u*h/100;return{product_id:c.value,product_name:c.label,product_code:c.product_code,qty:c.qty,mrp:c.mrp,discount:h,sub_total:u,net_price:k}}),i=e.length,t=e.reduce((c,u)=>c+ +u.qty,0),d=e.reduce((c,u)=>c+u.sub_total,0),p=e.reduce((c,u)=>c+u.net_price,0),V=d-p,x=O(B({},this.stockForm.value),{item:e,total_items:i,total_qty:t,sub_total:d,net_amount:p,total_discount:V});delete x.product_id,delete x.qty,delete x.price,this.api.disabled=!0,this.api.post(x,"complaint-invoice/create").subscribe(c=>{this.api.disabled=!1,c.statusCode===200&&(this.toastr.success(c.message,"","toast-top-right"),this.dialogRef.close(!0))})}else{this.toastr.error("Form Is Invalid","",{positionClass:"toast-top-right"}),this.formValidation.markFormGroupTouched(this.stockForm);let e=Object.keys(this.stockForm.controls).filter(i=>this.stockForm.get(i)?.invalid);console.log("\u274C Invalid Fields:",e)}}delete(o){this.selectedItems.splice(o,1),this.stockForm.get("item").removeAt(o)}static \u0275fac=function(e){return new(e||n)(f(ue),f(le),f(se),f(ne),f(Fe),f(pe),f(z),f(xe),f(H),f(W))};static \u0275cmp=j({type:n,selectors:[["app-service-invoice-modal"]],decls:2,vars:2,consts:[["f","ngForm"],["status","ngModel"],["reason","ngModel"],["class","mat-dialoge",4,"ngIf"],[1,"mat-dialoge"],[3,"close","title","closeBtn"],[3,"ngSubmit"],[1,"mat-typography","py-1"],[1,""],[1,"form-label","mb-0"],[1,"text-red-500"],[1,"mat-custom-field","remove-space"],["placeholder","Select an option","name","status","required","",3,"ngModelChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],["class","mt-1 text-xs text-red-500 text-right",4,"ngIf"],["class","mt-2",4,"ngIf"],["align","end",1,"gap-2"],[3,"buttonType","buttonClass","disabled","formType","iconClass","loadingIconClass"],[3,"value"],[1,"mt-1","text-xs","text-red-500","text-right"],[4,"ngIf"],[1,"mt-2"],[1,"mat-custom-field","remove-space","text-area-height"],["matInput","","placeholder","Type Here ...","name","reason","required","",3,"ngModelChange","ngModel"],[3,"ngSubmit","formGroup"],[1,"mat-typography"],["class","grid grid-cols-12 gap-x-6",4,"ngIf"],["align","end"],[1,"grid","grid-cols-12","gap-x-6"],[1,"xl:col-span-12","col-span-12"],[1,"grid","grid-cols-12","sm:gap-x-6"],[1,"xxl:col-span-3","xl:col-span-6","lg:col-span-6","md:col-span-6","col-span-12"],["formControlName","payment_mode","label","Payment Mode",3,"options","multiple","fieldReq"],["class","xxl:col-span-3 xl:col-span-6 lg:col-span-6 md:col-span-6 col-span-12",4,"ngIf"],["formControlName","product_id","label","Select Product",3,"searchChanged","search","fieldReq","options","multiple"],["class","xxl:col-span-2 xl:col-span-3 lg:col-span-3 md:col-span-4 col-span-12 mb-3",4,"ngIf"],[1,"flex","justify-start","mt-6"],["type","button","aria-label","button",1,"ti-btn","ti-btn-icon","ti-btn-primary","btn-wave",3,"click"],[1,"ri-add-line"],["class","table-responsive mt-4 table-bordered-default",4,"ngIf"],["label","Transaction Number","formControlName","transaction_number","type","text",1,"remove-default-class",3,"fieldReq"],[1,"xxl:col-span-2","xl:col-span-3","lg:col-span-3","md:col-span-4","col-span-12","mb-3"],["label","MRP","formControlName","price","type","number",1,"remove-default-class",3,"fieldReq"],["label","Discount (%)","formControlName","total_discount","type","number",1,"remove-default-class",3,"fieldReq"],["label","Qty","formControlName","qty","type","number",1,"remove-default-class",3,"fieldReq"],[1,"table-responsive","mt-4","table-bordered-default"],["tableClass","ti-custom-table ti-custom-table-hover ti-head-primary",3,"columns","tableHead","showCheckbox","showS_No","showAction"],[4,"ngFor","ngForOf"],[1,"w60","text-center"],[1,"text-right"],[1,"w60","relative"],[1,"flex","flex-row","items-center","!gap-2","text-[0.9375rem]"],[3,"clickEvent","icon","buttonClass"]],template:function(e,i){e&1&&v(0,Ae,18,13,"div",3)(1,Ue,7,10,"div",3),e&2&&(s("ngIf",i.modalData.lastPage==="invoice-detail"),a(),s("ngIf",i.modalData.lastPage==="complaint-detail"))},dependencies:[re,ee,J,K,X,oe,te,ie,ge,ce,ve,_e,me,de,fe,Ie,L,U,$,Z,ye,he,Se,Me,G,Y,ae,Ce,be],encapsulation:2})};export{Ve as a};
