import{a as De}from"./chunk-GXF7AAOQ.js";import{a as ve}from"./chunk-PU6S26UW.js";import{a as Ie}from"./chunk-ZON5AR26.js";import"./chunk-LGZVJJDX.js";import{a as Se}from"./chunk-54KZ5YIV.js";import"./chunk-SQZ3YN6N.js";import{c as be}from"./chunk-CIBZCVJQ.js";import{a as Fe}from"./chunk-OTFCGVEU.js";import{a as ye}from"./chunk-HPLI5COI.js";import"./chunk-DUVWFXSE.js";import"./chunk-OEHD5D2Y.js";import{a as Ce}from"./chunk-GLWQGYBC.js";import{a as ne}from"./chunk-DC4QM32I.js";import{C as _e,F as ge,c as re,f as ce,k as he,n as fe,v as ue}from"./chunk-VHE3PQ3O.js";import{C as q,D as W,H as Q,M as Z,Qa as me,V as ee,W as ie,X as te,Y as oe,Z as se,aa as ae,ca as de,da as le,hb as pe,l as X,o as b,w as Y}from"./chunk-GYDYF5F3.js";import{K as J,M as K,f as B,g as H,n as z,t as $}from"./chunk-PD5VTTIY.js";import{Aa as S,Ba as I,Hb as V,Ob as F,Xc as N,Yc as O,_b as c,cc as w,ed as j,fd as G,kc as _,lc as g,mc as R,nc as A,oc as k,qc as L,qd as P,rb as u,sb as l,wc as D,yc as h}from"./chunk-2NSPOFEK.js";import"./chunk-EU2KAMEK.js";import{a as M,i as U}from"./chunk-66YHNWRR.js";var Ee=()=>["User"],Me=()=>[];function Ue(r,i){r&1&&(_(0,"div",8),R(1,"app-skeleton"),g())}function Re(r,i){r&1&&(_(0,"div",4)(1,"div",5)(2,"div",6),F(3,Ue,2,0,"div",7),g()()()),r&2&&(u(3),c("ngForOf",O(1,Me).constructor(10)))}function Le(r,i){if(r&1){let e=L();_(0,"div")(1,"app-form-field",17,0),D("searchChanged",function(o){S(e);let s=h().$implicit,a=h(4);return I(s.search?a.onSearch(o,s):"")})("valueChange",function(o){S(e);let s=h().$implicit,a=h(4);return I(a.onFieldChange(o,s))}),g()()}if(r&2){let e=h().$implicit,t=h(4);w("mb-4 ",e.class_name,""),u(),c("field",e)("form",t.myForm)}}function Oe(r,i){if(r&1&&(A(0),F(1,Le,3,5,"div",16),k()),r&2){let e=i.$implicit;u(),c("ngIf",e.is_show===!0&&(e.is_parent_dependency===!1||e.is_child_show===!0))}}function Ve(r,i){if(r&1&&(_(0,"div",6),F(1,Oe,2,1,"ng-container",15),g()),r&2){let e=h(3);u(),c("ngForOf",e.formFields)}}function we(r,i){if(r&1){let e=L();_(0,"form",11),D("ngSubmit",function(){S(e);let o=h(2);return I(o.onSubmit())}),_(1,"div",4)(2,"div",5),F(3,Ve,2,1,"div",12),g(),_(4,"div",13),R(5,"app-button",14),g()()()}if(r&2){let e=h(2);c("formGroup",e.myForm),u(3),c("ngIf",e.myForm&&e.myForm.controls),u(2),c("buttonType","submit")("buttonClass","ti-btn ti-btn-primary m-0")("disabled",e.api.disabled)("formType",e.pageType)("iconClass","ri-save-line")("loadingIconClass","ri-loader-2-fill")}}function Ae(r,i){if(r&1&&(_(0,"div",9),F(1,we,6,8,"form",10),g()),r&2){let e=h();u(),c("ngIf",e.formIniatialized)}}var Te=class r{constructor(i,e,t,o,s,a,m,p,v,T,y,x,f,E,n){this.spaceRemove=i;this.fb=e;this.util=t;this.toastr=o;this.api=s;this.cdRef=a;this.dialog=m;this.router=p;this.formValidation=v;this.logService=T;this.route=y;this.moduleService=x;this.uploadService=f;this.authService=E;this.comanFuncation=n;this.orgData=this.authService.getOrg()}formGroup=new W({});formFields=[];myForm;primaryForm;FORMID=ye;moduleFormId=0;moduleId={};uploadedImages=[];binaryFiles=[];uploadedLabel;skLoading=!1;fieldTypes=X;formIniatialized=!1;tagsElement;type="component";Math=Math;statList=[];reportingManagerList=[];orgData={};pageType="add";userId;loginType;submodule={};pondFiles=[];originalFormFields=[];UploadFiles=[];ngOnInit(){let i=this.moduleService.getSubModuleByName("Masters","Users"),e=this.moduleService.getFormById("Masters","Users",this.FORMID.ID.UserForm);i&&(this.submodule=i),e&&(this.submodule.form_id=e.form_id,this.moduleFormId=e.form_id,this.getFormData()),this.route.paramMap.subscribe(t=>{if(t){this.loginType=t.get("login_type_id"),this.userId=t.get("id");let o=t.get("edit");this.pageType=o||"add"}})}lastSearchTerm="";onSearch(i,e){let t=i?.trim()||"";t!==this.lastSearchTerm&&(this.lastSearchTerm=t,this.api.post({dropdown_name:e.name,search:t},e.api_path).subscribe({next:o=>{o.statusCode===200&&(e.options=o.data)}}))}initializeForm(){this.myForm=this.fb.group({}),this.formFields.forEach(i=>{if(i.api_path){if(i.api_payload_key){let e=new Set;(this.orgData.sfa||this.orgData.irp||this.orgData.dms||this.orgData.wcms||this.orgData.wms)&&e.add(b.SYSTEM_USER),this.orgData.sfa&&e.add(b.FIELD_USER),this.orgData.wms&&e.add(b.WHAREHOUSE),this.orgData.wcms&&(e.add(b.SERVICE_VENDOR),e.add(b.SERVICE_FIELD_USER)),i.api_payload_key=Array.from(e)}this.getOptions(i.name,i.api_path,i.api_payload,i.api_payload_key)}i.control=this.fb.control("",this.formValidation.getValidators(i)),this.myForm.addControl(i.name,i.control)}),this.formIniatialized=!0,this.userId&&this.getUserDetail()}onResetDependentFields(i){this.formFields[i].child_dependency.length!=0&&this.formFields[i].child_dependency.map(e=>{let t=this.formFields.findIndex(o=>o.name===e.child_field_name);t!==-1&&(this.myForm.controls[e.child_field_name].reset(),this.formFields[t].value=""),this.onResetDependentFields(t)})}onFieldChange(i,e){if(console.log(i,"value"),console.log(e,"field"),(e.type==this.fieldTypes.SINGLE_SELECT||e.type==this.fieldTypes.MULTI_SELECT||e.type==this.fieldTypes.RADIO_SELECT||e.type==this.fieldTypes.CHECKBOX_SELECT||e.type==this.fieldTypes.DATE||e.type==this.fieldTypes.TIME||e.type==this.fieldTypes.UPLOAD)&&(e.type==this.fieldTypes.SINGLE_SELECT?(e.control.setValue(i),console.log(e.control,"field.control"),console.log(e,"field"),e.value=i.label):e.control.setValue(i)),e.type===this.fieldTypes.DATE_RANGE){let t={from:i.from,to:i.to};this.myForm.controls[e.name].setValue(t)}if(e.type===this.fieldTypes.UPLOAD){for(let t=0;t<this.UploadFiles.length;t++)this.UploadFiles[t].label===e.label&&this.UploadFiles.splice(t,1);Object.assign(i,{image_type:e.label}),this.UploadFiles.push({file:i})}if(e?.actual_name){let t=e.options.findIndex(o=>o.value===i);t!==-1&&e.type===this.fieldTypes.SINGLE_SELECT&&e.key_source==="default"&&(e[e.actual_name]=e.options[t].label)}if(e.is_child_dependency===!0){let t=e.options.findIndex(o=>o.value===i);t!==-1&&(e.type===this.fieldTypes.SINGLE_SELECT&&e.key_source==="default"?(e.value=e.options[t].value,e.visibilty):(e.value=e.options[t].label,e.visibilty))}if(e.is_child_dependency){let t=this.formFields.findIndex(o=>o.name==e.name);this.onResetDependentFields(t);for(let o=t;o<=this.formFields.length-1;o++){let s=this.formFields[o].options?.find(p=>this.spaceRemove.formatString(p.value)==this.spaceRemove.formatString(this.formFields[o].value));s?.value!=e.value&&(s=this.formFields[o].options?.find(p=>p.value===this.formFields[o].value));let a=s?.label||void 0,m=0;for(let p=0;p<=this.formFields[o].child_dependency.length-1;p++){let v=!1,T=this.formFields[o].child_dependency,y=this.formFields[o].child_dependency[p];if(y.visibilty==="Direct"&&a&&(y.parent_field_value===a||y.child_field_option.length===0&&this.formFields[o].is_child_show)&&(v=!0,y?.api_path&&y.parent_field_value===a&&this.getDirectOptions(y.child_field_name,y.api_path)),this.formFields[o].child_dependency[p].visibilty==="Option"){let f=this.formFields.findIndex(n=>n.name==this.formFields[o].child_dependency[p].child_field_name);if(f!==-1&&this.formFields[f].type===this.fieldTypes.SHORT_TEXT&&this.formFields[o].value&&(v=!0,this.formFields[f].is_child_show=v),this.formFields[o].child_dependency[p].child_field_option.findIndex(n=>n.parent_field_value==a&&n.parent_field_name==this.formFields[o].name)!==-1){v=!0;let n=this.formFields.findIndex(d=>d.name==this.formFields[o].child_dependency[p].child_field_name);this.formFields[n].options=this.formFields[o].child_dependency[p].child_field_option.filter(d=>d.parent_field_name==this.formFields[o].name&&d.parent_field_value==a)}}let x=this.formFields.findIndex(f=>f.name==this.formFields[o].child_dependency[p].child_field_name&&this.formFields[o].child_dependency[p].parent_field_value==a);if(x!==-1)this.formFields[x].is_child_show=v;else{let f=T.filter((n,d,C)=>d===C.findIndex(xe=>xe.child_field_name===n.child_field_name&&n.parent_field_value!=a)),E=T.filter((n,d,C)=>n.parent_field_value==a);f=f.filter(n=>!E.some(d=>d.child_field_name===n.child_field_name)),f.map(n=>{let d=this.formFields.findIndex(C=>C.name==n.child_field_name);if(m!=d&&d!==-1&&this.formFields[d]){let C=this.formFields[d];this.formFields[d].is_child_show=!1}m=d})}}}}e.name==="state"&&this.getDistrict(i),e.check_duplicate&&i.length===e.api_call_length&&this.checkDuplicate(e.api_path,e.name,i),e.name==="pincode"&&i.length===6&&this.getPostalMaster(i)}onDeleteImage(i){this.uploadedImages.splice(i,1)}onClick(i){}getFormData(){this.skLoading=!0,this.api.post({form_id:this.moduleFormId,platform:"web"},"form-builder/read").subscribe(i=>{i.statusCode==200&&(i?.data?.form_data&&(this.originalFormFields=JSON.parse(JSON.stringify(i.data.form_data))),this.formFields=i.data.form_data,this.skLoading=!1,this.formFields.forEach(e=>{this.util.createValidation(e)}),this.getReportingManager(),this.getUserRole(),this.getState(),this.initializeForm())})}getDirectOptions(i,e){return U(this,null,function*(){this.skLoading=!0;try{let t={module_id:this.submodule.sub_module_id||this.submodule.module_id},o=yield this.api.post(t,e).toPromise();o?.statusCode===200&&(this.skLoading=!1,this.formFields.forEach(s=>{s.name===i&&(s.options=o.data)}),this.originalFormFields.forEach(s=>{s.name===i&&(s.options=o.data)}))}catch(t){console.error("Error fetching options:",t)}})}getOptions(i,e,t,o){return U(this,null,function*(){try{let s={dropdown_name:i,module_id:this.submodule.sub_module_id||this.submodule.module_id};i==="reporting_manager_id"&&this.userId&&(s.user_id=this.userId),t&&o&&(s[o]=t);let a=yield this.api.post(s,e).toPromise();a?.statusCode===200&&(this.formFields.forEach(m=>{m.name===i&&(m.options=a.data)}),this.originalFormFields.forEach(m=>{m.name===i&&(m.options=a.data)}))}catch(s){console.error("Error fetching options:",s)}})}originalData={};getUserDetail(){this.skLoading=!0,this.api.post({_id:this.userId},"user/read-detail").subscribe(i=>{if(i.statusCode===200){this.skLoading=!1;let e;e=i.data,this.originalData=M(M({},e),e.form_data),this.originalData.state&&this.getDistrict(this.originalData.state),delete this.originalData.form_data;let t=Object.keys(this.originalData),o=this.formFields.filter(s=>t.includes(s.name)&&(s.type===this.fieldTypes.SINGLE_SELECT||s.type===this.fieldTypes.MULTI_SELECT));if(this.myForm.patchValue(this.originalData),o.length>0)for(let s=0;s<o.length;s++){this.onFieldChange(o[s].control?.value,o[s]);let a=o[s].name;this.myForm.controls[a]&&this.myForm.controls[a].setValue(this.originalData[a]);for(let m=0;m<this.formFields.length;m++)this.formFields[m].name===a&&this.originalData[a]&&(this.formFields[m].is_child_show=!0,this.formFields[m].value=this.originalData[a])}}})}formatDateForFlatpickr(i){return i?new Date(i).toISOString().split("T")[0]:""}cleanDetailObject(){if(!this.originalData||!this.myForm.value)return;let i=this.myForm.value;this.originalData=Object.keys(this.originalData).filter(e=>e in i).reduce((e,t)=>(e[t]=this.originalData[t],e),{})}onSubmit(){if(this.formFields.forEach(i=>{(i.is_child_show===!1||i.is_show===!1)&&(this.myForm.get(i.name)?.clearValidators(),this.myForm.get(i.name)?.updateValueAndValidity())}),this.myForm.valid){this.api.disabled=!0;let i={primaryFields:{form_data:{}}};this.formFields.forEach(s=>{s.name&&this.myForm.value.hasOwnProperty(s.name)&&(s.read_only===!1&&s.key_source!=="custom"&&(i.primaryFields[s.name]=this.myForm.value[s.name]),s.key_source==="custom"&&(i.primaryFields.form_data[s.name]=this.myForm.value[s.name]),s?.actual_name&&(i.primaryFields[s.actual_name]=s[s.actual_name]),s.type===this.fieldTypes.UPLOAD&&delete i.primaryFields.form_data[s.name])}),i.primaryFields.form_data.files=this.myForm.value.files,this.formValidation.removeEmptyFields(i.primaryFields),this.formValidation.removeEmptyFields(i.primaryFields.form_data);let e=this.pageType==="edit";if(e&&(i.primaryFields._id=this.userId,this.logService.logActivityOnUpdate(e,this.originalData,this.myForm.value,this.submodule.sub_module_id,this.submodule.title,"update",this.originalData._id||null,()=>{},this.submodule.module_type)&&this.UploadFiles.length===0)){this.api.disabled=!1,this.toastr.warning("No changes detected","","toast-top-right");return}let t=e?"patch":"post",o=e?"user/update":"user/create";this.api[t](i.primaryFields,o).subscribe(s=>{s.statusCode===200&&(this.UploadFiles.length>0?(this.api.disabled=!0,this.uploadService.uploadFile(s.data.inserted_id,"user",this.UploadFiles,"User Images",this.submodule,"/apps/master/user/user-list")):(this.api.disabled=!1,this.comanFuncation.setHighLight("userList","add","",{},1),this.router.navigate(["/apps/master/user/user-list"]),this.toastr.success(s.message,"","toast-top-right")))})}else this.toastr.error("Form Is Invalid","","toast-top-right"),this.formValidation.markFormGroupTouched(this.myForm)}openModal(i){this.dialog.open(Ie,{data:{lastPage:"user-add",form_Fields:this.originalFormFields,moduleFormId:this.moduleFormId,moduleId:this.submodule.sub_module_id,moduleName:this.submodule.title,moduleData:this.submodule}}).afterClosed().subscribe(t=>{t===!0&&this.getFormData()})}checkDuplicate(i,e,t){let o={[e]:t};this.api.post(o,i).subscribe(s=>{s===!1?this.api.isDuplicate=!0:this.api.isDuplicate=!1})}getReportingManager(){this.api.post({},"user/read-dropdown").subscribe(i=>{if(i.statusCode==200){this.reportingManagerList=i.data;for(let e=0;e<this.formFields.length;e++)(this.formFields[e].name==="reporting_manager_id"||this.formFields[e].name==="reporting_manager_2"||this.formFields[e].name==="hod")&&(this.formFields[e].options=i.data)}})}getUserRole(){this.api.post({},"rbac/read-dropdown").subscribe(i=>{if(i.statusCode==200)for(let e=0;e<this.formFields.length;e++)this.formFields[e].name==="user_role_id"&&(this.formFields[e].options=i.data)})}getState(){this.api.post({},"postal-code/states").subscribe(i=>{if(i.statusCode==200){this.statList=i.data;for(let e=0;e<this.formFields.length;e++)(this.formFields[e].name==="state"||this.formFields[e].name==="holiday_profile"||this.formFields[e].name==="assigned_area")&&(this.formFields[e].options=i.data)}})}getDistrict(i){this.api.post({state:i},"postal-code/districts").subscribe(e=>{if(e.statusCode==200)for(let t=0;t<this.formFields.length;t++)this.formFields[t].name==="district"&&(this.formFields[t].options=e.data)})}getPostalMaster(i){this.api.post({pincode:i},"postal-code/read-using-pincode").subscribe(e=>{if(e.statusCode==200)for(let t=0;t<this.formFields.length;t++)this.formFields[t].name==="state"&&(this.myForm.controls.state.setValue(e.data.state),this.getDistrict(e.data.state)),this.formFields[t].name==="district"&&this.myForm.controls.district.setValue(e.data.district),this.formFields[t].name==="city"&&this.myForm.controls.city.setValue(e.data.city)})}static \u0275fac=function(e){return new(e||r)(l(Se),l(ee),l(oe),l(Y),l(se),l(P),l(me),l(K),l(ue),l(Fe),l(J),l(ne),l(ve),l(ae),l(be))};static \u0275cmp=V({type:r,selectors:[["app-user-add"]],inputs:{formFields:"formFields"},features:[N([de])],decls:4,vars:16,consts:[["dynamicForm",""],[3,"buttonClick","buttonClick1","title","title1","activeitem","buttonText","icon","btnShow","buttonValue","buttonText1","icon1","btnShow1","buttonValue1"],["class","box",4,"ngIf"],["class","xl:col-span-12 col-span-12",4,"ngIf"],[1,"box"],[1,"p-4"],[1,"grid","grid-cols-12","gap-x-6"],["class","xl:col-span-3 col-span-12 mb-4",4,"ngFor","ngForOf"],[1,"xl:col-span-3","col-span-12","mb-4"],[1,"xl:col-span-12","col-span-12"],[3,"formGroup","ngSubmit",4,"ngIf"],[3,"ngSubmit","formGroup"],["class","grid grid-cols-12 gap-x-6",4,"ngIf"],[1,"box-footer","border-t","border-block-start-dashed","sm:flex","justify-end"],[3,"buttonType","buttonClass","disabled","formType","iconClass","loadingIconClass"],[4,"ngFor","ngForOf"],[3,"class",4,"ngIf"],[3,"searchChanged","valueChange","field","form"]],template:function(e,t){e&1&&(_(0,"app-page-header",1),j(1,"titlecase"),D("buttonClick",function(s){return t.onClick(s)})("buttonClick1",function(s){return t.openModal(s)}),g(),F(2,Re,4,2,"div",2)(3,Ae,2,1,"div",3)),e&2&&(c("title","Master Modules")("title1",O(15,Ee))("activeitem",G(1,13,t.pageType)+" User")("buttonText","Filter")("icon","filter_list")("btnShow",!1)("buttonValue","filter_data")("buttonText1","Form Config")("icon1","settings")("btnShow1",!0)("buttonValue1",""),u(2),c("ngIf",t.skLoading),u(),c("ngIf",!t.skLoading))},dependencies:[ge,B,H,Q,q,Z,Ce,De,re,_e,z,le,ce,he,ie,fe,te,pe,$],encapsulation:2})};export{Te as UserAddComponent};
