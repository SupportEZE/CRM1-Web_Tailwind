import{a as ye}from"./chunk-GXF7AAOQ.js";import{a as pe}from"./chunk-PU6S26UW.js";import{a as _e}from"./chunk-ZON5AR26.js";import"./chunk-LGZVJJDX.js";import{a as ue}from"./chunk-54KZ5YIV.js";import"./chunk-SQZ3YN6N.js";import{c as he}from"./chunk-CIBZCVJQ.js";import{a as ce}from"./chunk-OTFCGVEU.js";import{a as me}from"./chunk-HPLI5COI.js";import"./chunk-DUVWFXSE.js";import"./chunk-OEHD5D2Y.js";import{a as fe}from"./chunk-GLWQGYBC.js";import{a as ie}from"./chunk-DC4QM32I.js";import{C as de,F as le,c as ee,f as se,k as ae,n as ne,v as re}from"./chunk-VHE3PQ3O.js";import{C as $,D as H,H as J,M as K,Qa as te,V as X,W as q,X as Y,Y as Q,Z as W,aa as Z,hb as oe,l as P,o as B,w as z}from"./chunk-GYDYF5F3.js";import{K as j,M as G,f as k,g as N,n as R,t as w}from"./chunk-PD5VTTIY.js";import{Aa as v,Ba as b,Hb as L,Ob as _,Yc as D,_b as l,cc as M,ed as O,fd as U,kc as p,lc as h,mc as T,nc as A,oc as V,qc as x,rb as c,sb as d,wc as S,yc as m}from"./chunk-2NSPOFEK.js";import"./chunk-EU2KAMEK.js";import{a as C,i as E}from"./chunk-66YHNWRR.js";var ve=()=>["Site"],be=()=>[];function Se(r,i){r&1&&(p(0,"div",8),T(1,"app-skeleton"),h())}function Ie(r,i){r&1&&(p(0,"div",4)(1,"div",5)(2,"div",6),_(3,Se,2,0,"div",7),h()()()),r&2&&(c(3),l("ngForOf",D(1,be).constructor(10)))}function Ce(r,i){if(r&1){let e=x();p(0,"div")(1,"app-form-field",17,0),S("searchChanged",function(s){v(e);let o=m().$implicit,n=m(4);return b(o.search?n.onSearch(s,o):"")})("valueChange",function(s){v(e);let o=m().$implicit,n=m(4);return b(n.onFieldChange(s,o))}),h()()}if(r&2){let e=m().$implicit,t=m(4);M("mb-4 ",e.class_name,""),c(),l("field",e)("form",t.myForm)}}function Te(r,i){if(r&1&&(A(0),_(1,Ce,3,5,"div",16),V()),r&2){let e=i.$implicit;c(),l("ngIf",e.is_show===!0&&(e.is_parent_dependency===!1||e.is_child_show===!0))}}function xe(r,i){if(r&1&&(p(0,"div",6),_(1,Te,2,1,"ng-container",15),h()),r&2){let e=m(3);c(),l("ngForOf",e.formFields)}}function De(r,i){if(r&1){let e=x();p(0,"form",11),S("ngSubmit",function(){v(e);let s=m(2);return b(s.onSubmit())}),p(1,"div",4)(2,"div",5),_(3,xe,2,1,"div",12),h(),p(4,"div",13),T(5,"app-button",14),h()()()}if(r&2){let e=m(2);l("formGroup",e.myForm),c(3),l("ngIf",e.myForm&&e.myForm.controls),c(2),l("buttonType","submit")("buttonClass","ti-btn ti-btn-primary m-0")("disabled",e.api.disabled)("formType",e.pageType)("iconClass","ri-save-line")("loadingIconClass","ri-loader-2-fill")}}function Ee(r,i){if(r&1&&(p(0,"div",9),_(1,De,6,8,"form",10),h()),r&2){let e=m();c(),l("ngIf",e.formIniatialized)}}var Fe=class r{constructor(i,e,t,s,o,n,a,f,g,I,y,ge,u,F){this.moduleService=i;this.api=e;this.util=t;this.formValidation=s;this.fb=o;this.dialog=n;this.route=a;this.router=f;this.logService=g;this.toastr=I;this.authService=y;this.spaceRemove=ge;this.uploadService=u;this.comanFuncation=F}skLoading=!1;FORMID=me;submodule;moduleFormId=0;moduleTableId=0;UploadFiles=[];originalFormFields=[];formGroup=new H({});formFields=[];myForm;primaryForm;formIniatialized=!1;orgData={};pageType="add";originalData={};fieldTypes=P;DetailId;statList=[];ngOnInit(){this.orgData=this.authService.getUser();let i=this.moduleService.getSubModuleByName("SFA","Site-Project"),e=this.moduleService.getFormById("SFA","Site-Project",this.FORMID.ID.SiteForm);i&&(this.submodule=i),e&&(this.moduleFormId=e.form_id,this.getFormData()),this.route.paramMap.subscribe(t=>{if(t){this.DetailId=t.get("id");let s=t.get("edit");this.pageType=s||"add"}})}lastSearchTerm="";onSearch(i,e){let t=i?.trim()||"";t!==this.lastSearchTerm&&(this.lastSearchTerm=t,this.api.post({dropdown_name:e.name,search:t},e.api_path).subscribe({next:s=>{s.statusCode===200&&(e.options=s.data)}}))}getFormData(){this.skLoading=!0,this.api.post({form_id:this.moduleFormId,platform:"web"},"form-builder/read").subscribe(i=>{i.statusCode==200&&(i?.data?.form_data&&(this.originalFormFields=JSON.parse(JSON.stringify(i.data.form_data))),this.formFields=i.data.form_data,this.skLoading=!1,this.formFields.forEach(e=>{this.util.createValidation(e)}),this.getState(),this.initializeForm())})}initializeForm(){this.myForm=this.fb.group({}),this.formFields.forEach(i=>{this.orgData.login_type_id===B.FIELD_USER&&i.name==="assigned_to_user_id"&&(i.is_show=!1),i.api_path&&this.getOptions(i.label,i.name,i.api_path),i.control=this.fb.control("",this.formValidation.getValidators(i)),this.myForm.addControl(i.name,i.control)}),this.formIniatialized=!0,this.DetailId&&this.getDetail()}getOptions(i,e,t){return E(this,null,function*(){try{let s=yield this.api.post({dropdown_name:i,module_id:this.submodule.sub_module_id||this.submodule.module_id},t).toPromise();s?.statusCode===200&&(this.formFields.forEach(o=>{o.name===e&&(o.options=s.data)}),this.originalFormFields.forEach(o=>{o.name===e&&(o.options=s.data)}))}catch(s){console.error("Error fetching options:",s)}})}getDetail(){this.api.post({_id:this.DetailId},"sites/detail").subscribe(i=>{if(i.statusCode===200){let e;e=i.data,this.originalData=C(C({},e),e.form_data),delete this.originalData.form_data;let t=Object.keys(this.originalData),s=this.formFields.filter(o=>t.includes(o.name)&&(o.type===this.fieldTypes.SINGLE_SELECT||o.type===this.fieldTypes.MULTI_SELECT));if(this.myForm.patchValue(this.originalData),s.length>0)for(let o=0;o<s.length;o++){let n=s[o].name;this.myForm.controls[n]&&this.myForm.controls[n].setValue(this.originalData[n]);for(let a=0;a<this.formFields.length;a++)this.formFields[a].name===n&&this.originalData[n]&&(this.formFields[a].is_child_show=!0,this.formFields[a].value=this.originalData[n],this.getDependencyUpdate(this.formFields[a]))}}})}onFieldChange(i,e){if(e.type==this.fieldTypes.SINGLE_SELECT||e.type==this.fieldTypes.MULTI_SELECT||e.type==this.fieldTypes.RADIO_SELECT||e.type==this.fieldTypes.CHECKBOX_SELECT||e.type==this.fieldTypes.DATE||e.type==this.fieldTypes.TIME||e.type==this.fieldTypes.UPLOAD){if(e.key_name_required===!0){let t=e.options.findIndex(o=>o.value===i),s;t!==-1&&(s=e.options[t].label,this.formFields.forEach(o=>{o.name===e.key_name&&this.myForm.controls[o.name].setValue(s)}))}e.type==this.fieldTypes.SINGLE_SELECT&&e.key_source=="custom"||e.type==this.fieldTypes.MULTI_SELECT&&e.key_source=="custom"?(e.control.setValue(i),e.value=i.label):e.control.setValue(i)}if(e.type===this.fieldTypes.DATE_RANGE){let t={from:i.from,to:i.to};this.myForm.controls[e.name].setValue(t)}if(e.name==="site_code"&&i.length>=3&&this.checkDuplicate(e.api_path,i),e.type===this.fieldTypes.UPLOAD){for(let t=0;t<this.UploadFiles.length;t++)this.UploadFiles[t].label===e.label&&this.UploadFiles.splice(t,1);this.UploadFiles.push({label:e.label,file:i})}if(e?.actual_name){let t=e.options.findIndex(s=>s.value===i);t!==-1&&e.type===this.fieldTypes.SINGLE_SELECT&&e.key_source==="default"&&(e[e.actual_name]=e.options[t].label)}if(e.is_child_dependency===!0){let t=e.options.findIndex(s=>s.value===i);t!==-1&&(e.type===this.fieldTypes.SINGLE_SELECT&&e.key_source==="default"?(e.value=e.options[t].value,this.getDependencyUpdate(e)):(e.value=e.options[t].label,this.getDependencyUpdate(e)))}if(e.is_child_dependency){let t=this.formFields.findIndex(s=>s.name==e.name);this.onResetDependentFields(t);for(let s=t;s<=this.formFields.length-1;s++){let n=this.formFields[s].options?.find(a=>this.spaceRemove.formatString(a.value)===this.spaceRemove.formatString(this.formFields[s].value))?.label||"";for(let a=0;a<=this.formFields[s].child_dependency.length-1;a++){let f=!1,g=this.formFields[s].child_dependency[a];if(g.visibilty==="Direct"&&(g.parent_field_value===n||g.child_field_option.length===0&&this.formFields[s].is_child_show)&&(f=!0),this.formFields[s].child_dependency[a].visibilty==="Option"){let y=this.formFields.findIndex(u=>u.name==this.formFields[s].child_dependency[a].child_field_name);if(y!==-1&&this.formFields[y].type===this.fieldTypes.SHORT_TEXT&&this.formFields[s].value&&(f=!0,this.formFields[y].is_child_show=f),this.formFields[s].child_dependency[a].child_field_option.findIndex(u=>u.parent_field_value==n&&u.parent_field_name==this.formFields[s].name)!==-1){f=!0;let u=this.formFields.findIndex(F=>F.name==this.formFields[s].child_dependency[a].child_field_name);this.formFields[u].options=this.formFields[s].child_dependency[a].child_field_option.filter(F=>F.parent_field_name==this.formFields[s].name&&F.parent_field_value==n)}}let I=this.formFields.findIndex(y=>y.name==this.formFields[s].child_dependency[a].child_field_name);I!==-1&&(this.formFields[I].is_child_show=f)}}}e.name==="state"&&this.getDistrict(i),e.name==="pincode"&&i.length===6&&this.orgData?.org?.postal_auto_fetch===1&&this.getPostalMaster(i)}getDependencyUpdate(i){if(i.is_child_dependency){let e,t,s;if(i.key_source==="default"){let o=i.options.find(n=>n.value===i.value);e=o?o.label:null}i.child_dependency.forEach(o=>{let n=this.formFields.find(a=>a.name===o.child_field_name);if(n){t=n.name;let a=o.child_field_option.find(f=>f.parent_field_value===e);s=a?a.label:null}}),t&&this.api.post({child_field_name:t,parent_field_value:e},"form-builder/read-dependency").subscribe(o=>{if(o?.statusCode===200&&o?.data){let n=this.formFields.find(a=>a.name===t);n&&(n.options=o.data)}})}}onResetDependentFields(i){this.formFields[i].child_dependency.length!=0&&this.formFields[i].child_dependency.map(e=>{let t=this.formFields.findIndex(s=>s.name===e.child_field_name);t!==-1&&(this.myForm.controls[e.child_field_name].reset(),this.formFields[t].value=""),this.onResetDependentFields(t)})}onSubmit(){if(this.formFields.forEach(i=>{(i.is_child_show===!1||i.is_show===!1)&&(this.myForm.get(i.name)?.clearValidators(),this.myForm.get(i.name)?.updateValueAndValidity())}),this.myForm.valid){this.api.disabled=!0;let i={primaryFields:{form_data:{}}};this.formFields.forEach(o=>{o.name&&this.myForm.value.hasOwnProperty(o.name)&&(o.read_only===!1&&o.key_source!=="custom"&&(i.primaryFields[o.name]=this.myForm.value[o.name]),o.key_source==="custom"&&(i.primaryFields.form_data[o.name]=this.myForm.value[o.name]),o?.actual_name&&(i.primaryFields[o.actual_name]=o[o.actual_name]),o.type===this.fieldTypes.UPLOAD&&delete i.primaryFields.form_data[o.name])}),i.primaryFields.form_data.files=this.myForm.value.files;let e=this.pageType==="edit";if(e&&(i.primaryFields._id=this.DetailId,this.logService.logActivityOnUpdate(e,this.originalData,this.myForm.value,this.submodule.module_id,this.submodule.title,"update",this.originalData._id||null,()=>{},this.submodule.module_type)&&this.UploadFiles.length===0)){this.api.disabled=!1,this.toastr.warning("No changes detected","","toast-top-right");return}let t=e?"patch":"post",s=e?"sites/update":"sites/create";this.api[t](i.primaryFields,s).subscribe(o=>{o.statusCode===200&&(this.UploadFiles.length>0?(this.api.disabled=!0,this.uploadService.uploadFile(o.data.inserted_id,"sites",this.UploadFiles,"Site Images",this.submodule,"/apps/sfa/site")):(this.api.disabled=!1,this.comanFuncation.setHighLight("userList","add","",{},1),this.router.navigate([e?`/apps/sfa/site/site-detail/${this.DetailId}`:"/apps/sfa/site"]),this.toastr.success(o.message,"","toast-top-right")))})}else{this.toastr.error("Form Is Invalid","","toast-top-right"),this.formValidation.markFormGroupTouched(this.myForm);let i=Object.keys(this.myForm.controls).filter(e=>this.myForm.get(e)?.invalid);console.warn("Invalid fields:",i)}}openModal(i){this.dialog.open(_e,{data:{lastPage:"site",form_Fields:this.originalFormFields,moduleFormId:this.moduleFormId,moduleId:this.submodule.module_id,moduleName:this.submodule.title,moduleData:this.submodule}}).afterClosed().subscribe(t=>{t===!0&&this.getFormData()})}checkDuplicate(i,e){this.api.post({site_code:e},i).subscribe(t=>{t===!1?this.api.isDuplicate=!0:this.api.isDuplicate=!1})}getState(){this.api.post({},"postal-code/states").subscribe(i=>{if(i.statusCode==200){this.statList=i.data;for(let e=0;e<this.formFields.length;e++)(this.formFields[e].name==="state"||this.formFields[e].name==="holiday_profile"||this.formFields[e].name==="assigned_area")&&(this.formFields[e].options=i.data)}})}getDistrict(i){this.api.post({state:i},"postal-code/districts").subscribe(e=>{if(e.statusCode==200)for(let t=0;t<this.formFields.length;t++)this.formFields[t].name==="district"&&(this.formFields[t].options=e.data)})}getPostalMaster(i){this.api.post({pincode:i},"postal-code/read-using-pincode").subscribe(e=>{if(e.statusCode==200)for(let t=0;t<this.formFields.length;t++)this.formFields[t].name==="state"&&(this.myForm.controls.state.setValue(e.data.state),this.getDistrict(e.data.state)),this.formFields[t].name==="district"&&this.myForm.controls.district.setValue(e.data.district),this.formFields[t].name==="city"&&this.myForm.controls.city.setValue(e.data.city)})}static \u0275fac=function(e){return new(e||r)(d(ie),d(W),d(Q),d(re),d(X),d(te),d(j),d(G),d(ce),d(z),d(Z),d(ue),d(pe),d(he))};static \u0275cmp=L({type:r,selectors:[["app-site-add"]],inputs:{formFields:"formFields"},decls:4,vars:14,consts:[["dynamicForm",""],[3,"buttonClick1","title","title1","activeitem","buttonText","icon","buttonText1","icon1","btnShow1","buttonValue1"],["class","box",4,"ngIf"],["class","xl:col-span-12 col-span-12",4,"ngIf"],[1,"box"],[1,"p-4"],[1,"grid","grid-cols-12","gap-x-6"],["class","xl:col-span-3 col-span-12 mb-4",4,"ngFor","ngForOf"],[1,"xl:col-span-3","col-span-12","mb-4"],[1,"xl:col-span-12","col-span-12"],[3,"formGroup","ngSubmit",4,"ngIf"],[3,"ngSubmit","formGroup"],["class","grid grid-cols-12 gap-x-6",4,"ngIf"],[1,"box-footer","border-t","border-block-start-dashed","sm:flex","justify-end"],[3,"buttonType","buttonClass","disabled","formType","iconClass","loadingIconClass"],[4,"ngFor","ngForOf"],[3,"class",4,"ngIf"],[3,"searchChanged","valueChange","field","form"]],template:function(e,t){e&1&&(p(0,"app-page-header",1),O(1,"titlecase"),S("buttonClick1",function(o){return t.openModal(o)}),h(),_(2,Ie,4,2,"div",2)(3,Ee,2,1,"div",3)),e&2&&(l("title","SFA")("title1",D(13,ve))("activeitem",U(1,11,t.pageType)+" Site")("buttonText","Filter")("icon","filter_list")("buttonText1","Form Config")("icon1","settings")("btnShow1",!0)("buttonValue1",""),c(2),l("ngIf",t.skLoading),c(),l("ngIf",!t.skLoading))},dependencies:[le,k,N,J,$,K,fe,ye,ee,de,R,se,ae,q,ne,Y,oe,w],encapsulation:2})};export{Fe as SiteAddComponent};
